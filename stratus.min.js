//     Stratus.js 1.0
//     Copyright (c) 2016 by Sitetheory, All Rights Reserved
//
//     All information contained herein is, and remains the
//     property of Sitetheory and its suppliers, if any.
//     The intellectual and technical concepts contained herein
//     are proprietary to Sitetheory and its suppliers and may be
//     covered by U.S. and Foreign Patents, patents in process,
//     and are protected by trade secret or copyright law.
//     Dissemination of this information or reproduction of this
//     material is strictly forbidden unless prior written
//     permission is obtained from Sitetheory.
//
//     For full details and documentation:
//     http://docs.sitetheory.io
!function(e,t){"function"==typeof define&&define.amd?define(["text","jquery","underscore","backbone","bowser","bootbox","promise","backbone.relational","jquery-cookie","jquery-toaster"],function(n,i,o,s,r,a){return e.Stratus=t(n,i,o,s,r,a)}):e.Stratus=t(e.text,e.$,e._,e.Backbone,e.bowser,e.bootbox)}(this,function(e,t,n,i,o,s){n.templateSettings={evaluate:/\{%(.+?)%\}/g,interpolate:/\{\{(.+?)\}\}/g,escape:/\{#(.+?)#\}/g};var r={Settings:{image:{size:{xs:200,s:400,m:600,l:800,xl:1200,hq:1600}}},DOM:{},Key:{},PostMessage:{},BaseUrl:(requirejs&&n.has(requirejs.s.contexts._,"config")?requirejs.s.contexts._.config.baseUrl:null)||"/",Collections:new i.Model,Models:new i.Model,Routers:new i.Model,Views:{Plugins:{},Widgets:{}},Events:{},Relations:{},Client:o,CSS:{},Chronos:null,Environment:new i.Model({production:!("string"==typeof document.cookie&&document.cookie.indexOf("env=")!==-1),language:navigator.language,timezone:(new Date).getTimezoneOffset()/60,debugNest:!1,liveEdit:!1,viewPortChange:!1,lastScroll:!1}),History:{},Instances:{},Internals:{},Prototypes:{},Resources:{},PluginMethods:{},RegisterGroup:{},Api:{GoogleMaps:"AIzaSyBatGvzPR7u7NZ3tsCy93xj4gEBfytffyA"}};r.Environment.get("production")||console.group("Stratus Warm Up"),n.mixin({ucfirst:function(e){return"string"==typeof e&&e?e.charAt(0).toUpperCase()+e.substring(1):null},lcfirst:function(e){return"string"==typeof e&&e?e.charAt(0).toLowerCase()+e.substring(1):null},converge:function(e,t){if("string"!=typeof t&&(t="min"),"min"===t){var i=n.min(e);return n.findKey(e,function(e){return e===i})}if("radial"===t);else if("gauss"!==t)return e},repeat:function(e,t){if("function"==typeof e&&"number"==typeof t){var n;for(n=0;n<t;n++)e()}else console.warn("Underscore cannot repeat function:",e,"with number of times:",t)},hydrate:function(e){return n.isJSON(e)?JSON.parse(e):e},hydrateString:function(e){return n.hydrate(e)},cloneDeep:function(e){if("object"!=typeof e)return e;var t=n.clone(e);return n.each(t,function(e,i){t[i]=n.cloneDeep(e)}),t},getUrlParams:function(e,t){var n={};return t="undefined"!=typeof t?t:window.location.href,t.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(e,t,i){n[t]=i}),"undefined"!=typeof e&&e?n[e]:n},allTrue:function(e){return"object"==typeof e&&n.every(e,function(e){return e})},isJSON:function(e){try{JSON.parse(e)}catch(t){return!1}return!0},seconds:function(e){var t=0;if("string"==typeof e){var i=e.match(/([\d+\.]*[\d+])(?=[sSmMhHdDwWyY]+)([sSmMhHdDwWyY]+)/gi);if(n.size(i)){var o,s,r,a=/([\d+\.]*[\d+])(?=[sSmMhHdDwWyY]+)([sSmMhHdDwWyY]+)/i;n.each(i,function(e){if(o=a.exec(e),r=parseFloat(o[1]),s=o[2],!isNaN(r)){switch(o[2]){case"s":s=1;break;case"m":s=60;break;case"h":s=3600;break;case"d":s=86400;break;case"w":s=604800;break;case"y":s=31558149.504;break;default:s=0}t+=r*s}},this)}else t=null}else t="number"==typeof e?e:null;return t}}),t.fn.dataAttr=function(e,t){return void 0===e&&console.error("$().dataAttr(key, value) contains an undefined key!"),void 0===t?(t=this.attr("data-"+e),n.isJSON(t)?JSON.parse(t):t):this.attr("data-"+e,JSON.stringify(t))},t.fn.notClicked=function(e){return this.selector||console.error("No Selector:",this),!t(e.target).closest(this.selector).length&&!t(e.target).parents(this.selector).length};var a=t("body").dataAttr("environment");return a&&"object"==typeof a&&n.size(a)&&r.Environment.set(a),i.Relational.store.addModelScope(r.Models.attributes),i.Relational.store.addModelScope(r.Collections.attributes),r.Relations.Sanitize=function(e,t,n){var i=null;return"undefined"!=typeof e.get(t)&&("object"==typeof e.get(t)&&null!==e.get(t)?"undefined"!=typeof e.get(t).get(n)&&(0===e.get(t).get(n).length||(i=1===e.get(t).get(n).length?e.get(t).get(n)[0]:e.get(t).get(n))):i=e.get(t)),i},r.Instances.Clean=function(e){return"undefined"==typeof e?console.error("Stratus.Instances.Clean() requires a string or array containing Unique ID(s)."):"string"==typeof e&&(e=[e]),!("object"!=typeof e||!Array.isArray(e))&&void n.each(e,function(e){n.has(r.Instances,e)&&("function"==typeof r.Instances[e].remove&&r.Instances[e].remove(),delete r.Instances[e])})},r.Prototypes.Error=function(e,t){this.code="Internal",this.message="No discernible data received.",this.chain=[],"string"==typeof e?this.message=e:e&&"object"==typeof e&&n.extend(this,e),this.chain.push(t)},r.Prototypes.Dispatch=function(){return n.extend(this,i.Events)},r.Prototypes.Chronos=i.Model.extend({initialize:function(e){r.Environment.get("production")||console.info("Chronos Invoked!"),this.on("change",this.synchronize,this)},synchronize:function(){n.each(this.changed,function(e,t){"string"==typeof t&&t.indexOf(".")!==-1&&(t=n.first(t.split(".")),e=this.get(t)),!e.code&&e.enabled?e.code=setInterval(function(e){e.func.call(e.scope)},1e3*e.time,e):e.code&&!e.enabled&&(clearInterval(e.code),e.code=0)},this)},add:function(e,t,i){var o=null;return e=n.seconds(e),null!==e&&"function"==typeof t&&(o=n.uniqueId("job_"),i=i||window,this.set(o,{time:e,func:t,scope:i,code:0,enabled:!1})),o},enable:function(e){var t=this.has(e);return t&&this.set(e+".enabled",!0),t},disable:function(e){var t=this.has(e);return t&&this.set(e+".enabled",!1),t},toggle:function(e,t){var n=this.has(e);return n&&this.set(e+".enabled","boolean"==typeof t?t:!this.get(e+".enabled")),n}}),r.Chronos=new r.Prototypes.Chronos,r.Prototypes.Collection=function(e){return this.attributes={},this.temps={},this.toObject=function(e){return n.clone(this.attributes)},this.toJSON=function(e){return n.clone(this.attributes)},this.each=function(e,t){n.each.apply(void 0===t?this:t,n.union([this.attributes],arguments))},this.get=function(e){if("string"==typeof e&&e.indexOf(".")!==-1){var t=this.attributes,i=e.split(".");if(n.find(i,function(n){return"undefined"!=typeof t&&t&&"object"==typeof t?void(t=t[n]):(t=this.attributes[e],!0)},this),!n.isEqual(t,this.attributes))return t}return this.attributes[e]},this.has=function(e){return"undefined"!=typeof this.get(e)},this.size=function(){return n.size(this.attributes)},this.set=function(e,t){e&&"object"==typeof e?n.each(e,function(e,t){this.setAttribute(t,e)},this):this.setAttribute(e,t)},this.setAttribute=function(e,t){if("string"==typeof e&&e.indexOf(".")!==-1){var i=this.attributes,o=e.split(".");if(n.find(n.initial(o),function(e){return n.has(i,e)&&i[e]||(i[e]={}),"undefined"!=typeof i&&i&&"object"==typeof i?void(i=i[e]):(i=this.attributes,!0)},this),!n.isEqual(i,this.attributes)){var s=n.last(o);i&&"object"==typeof i&&(i[s]=t)}}else this.attributes[e]=t},this.temp=function(e,t){this.set(e,t),e&&"object"==typeof e?n.each(e,function(e,t){this.temps[t]=e},this):this.temps[e]=t},this.add=function(e,t){if(this.has(e)||this.set(e,[]),"undefined"!=typeof t&&!n.contains(this.attributes[e],t))return this.attributes[e].push(t),t},this.remove=function(e,t){return void 0===t||(this.attributes[e]=n.without(this.attributes[e],t)),this.attributes[e]},this.iterate=function(e){return this.has(e)||this.set(e,0),++this.attributes[e]},this.clear=function(){for(var e in this.attributes)this.attributes.hasOwnProperty(e)&&delete this.attributes[e]},this.clearTemp=function(){for(var e in this.temps)this.temps.hasOwnProperty(e)&&delete this.temps[e]},this.initialize=function(){return!0},this.initialize.apply(this,arguments),this},r.Internals.LoadCss=function(e){return new Promise(function(t,i){"undefined"!=typeof e&&"function"!=typeof e||i(new r.Prototypes.Error({code:"LoadCSS",message:"CSS Resource URLs must be defined as a String, Array, or Object."},this)),"string"==typeof e&&(e=[e]);var o={total:e.length,iteration:0};o.total>0?n.each(e.reverse(),function(e){o.iteration++;var s=n.uniqueId("css_");o[s]=!1,"undefined"!=typeof e&&e?r.Internals.CssLoader(e).done(function(e){o[s]=!0,o.total===o.iteration&&n.allTrue(o)&&t(o)},i):(o[s]=!0,o.total===o.iteration&&n.allTrue(o)&&t(o))}):i(new r.Prototypes.Error({code:"LoadCSS",message:"No CSS Resource URLs found!"},this))})},r.Internals.OnScroll=function(e){return!(!e||0===e.length)&&(r.Environment.on("change:viewPortChange",function(e){if(e.get("viewPortChange")){e.set("lastScroll",r.Internals.GetScrollDir());var i=r.RegisterGroup.get("OnScroll");n.each(i,function(e){"undefined"!=typeof e&&n.has(e,"method")&&e.method(e)}),e.set("viewPortChange",!1),e.set("windowTop",t(window).scrollTop())}}),t(window).scroll(function(){r.Environment.get("viewPortChange")===!1&&r.Environment.set("viewPortChange",!0)}),t(window).resize(function(){r.Environment.get("viewPortChange")===!1&&r.Environment.set("viewPortChange",!0)}),void r.Environment.set("viewPortChange",!0))},r.Internals.GetScrollDir=function(){var e=t(window).scrollTop(),n=r.Environment.get("windowTop"),i=t(window).height(),o=t(document).height(),s=!!n&&e>n,a=!!n&&(e<n&&e+i<o);return s?"down":!!a&&"up"},r.Internals.IsOnScreen=function(e,n){n=n||0;var i=t(window).scrollTop(),o=i+t(window).height(),s=e.offset().top,r=s+e.height();return r>=i+n&&s<=o-n},r.Internals.Anchor=i.View.extend({el:'a[href*=\\#]:not([href=\\#]):not([data-scroll="false"])',events:{click:"clickAction"},clickAction:function(e){if(location.pathname.replace(/^\//,"")===e.currentTarget.pathname.replace(/^\//,"")&&location.hostname===e.currentTarget.hostname){var n=t(e.currentTarget.hash),o=e.currentTarget.hash.slice(1);if(n=n.length?n:t("[name="+o+"]"),n.length)return t("html,body").animate({scrollTop:n.offset().top},1e3,function(){i.history.navigate(o)}),!1}}}),r.Internals.LazyLoad=i.View.extend({el:"img[data-src]",initialize:function(){if(0===this.$el.length)return!1;var e;n.each(this.$el,function(n){e=t(n),r.RegisterGroup.add("OnScroll",{method:r.Internals.LoadImage,el:e,spy:t(t(n).data("spy")?t(n).data("spy"):n)})})}}),r.Internals.LoadImage=function(e){if(e.el.addClass("placeholder"),r.Internals.IsOnScreen(e.spy)){var i=e.el.data("src");"lazy"===i&&(i=e.el.attr("src"));var o=null;if(e.el.data("size")&&o.indexOf(e.el.data("size"))!==!1)o=e.el.data("size");else{var s=null,a=null,l=null;if(e.el.prop("style").width?s=e.el.prop("style").width:e.el.attr("width")&&(s=e.el.attr("width")),s){var u=/([\d]+)(.*)/;s=u.exec(s),a=s[2],s=parseInt(s[1]),l="%"===a?s/100:null}if(!s||"%"===a){var d=t(n.first(e.el.parents(":visible")));s=d.width();var c=t(n.first(d.find('[class*="col-"]')));if(c.length>0){var f=r.Internals.GetColWidth(c);f&&(s=Math.round(s/f))}l&&(s=Math.round(s*l))}if(s<=0)return!1;o=n.findKey(r.Settings.image.size,function(e,t){return e>s}),o=o||"hq"}var g=/^(.+?)(-[A-Z]{2})?\.(?=[^.]*$)(.+)/gi,p=g.exec(i);i=p[1]+"-"+o+"."+p[3],e.el.attr("src",i),e.el.addClass("loading"),e.el.load(function(){t(this).addClass("loaded").removeClass("placeholder loading")}),r.RegisterGroup.remove("OnScroll",e)}},r.Internals.GetColWidth=function(e){var t=e.attr("class"),n=/col-.{2}-([0-9]*)/g,i=n.exec(t);return"undefined"!=typeof i[1]&&i[1]},r.Internals.Location=function(e){return new Promise(function(t,i){"geolocation"in navigator?(e=n.extend({enableHighAccuracy:!0,timeout:2e4,maximumAge:5e4},e||{}),navigator.geolocation.getCurrentPosition(t,i,e)):i(new r.Prototypes.Error({code:"Location",message:"HTML5 Geo-Location isn't supported on this browser."},this))})},r.Internals.CssLoader=function(e){return new Promise(function(n,i){if(e in r.CSS)r.CSS[e]?n():r.Events.once("onload:"+e,n);else{r.CSS[e]=!1;var o=document.createElement("link");o.type="text/css",o.rel="stylesheet",o.href=e,r.Events.once("onload:"+e,function(){r.CSS[e]=!0,n()}),"onload"in o&&!r.Client.android?o.onload=function(){r.Events.trigger("onload:"+e)}:(r.CSS[e]=!0,r.Events.trigger("onload:"+e)),t("head").prepend(o)}})},r.Internals.Convoy=function(e,i){return new Promise(function(o,s){void 0===e&&s(new r.Prototypes.Error({code:"Convoy",message:"No Convoy defined for dispatch."},this)),t.ajax({type:"POST",url:"/Api"+encodeURIComponent(i||""),data:{convoy:JSON.stringify(e)},dataType:n.has(e,"meta")&&n.has(e.meta,"dataType")?e.meta.dataType:"json",xhrFields:{withCredentials:!0},crossDomain:!0,headers:{"Access-Control-Allow-Origin":"*"},success:function(e){return o(e),e},error:function(e){return s(new r.Prototypes.Error({code:"Convoy",message:e},this)),e}})})},r.Internals.Api=function(e,t,i){return void 0===e&&(e="Default"),void 0!==t&&null!==t||(t={}),void 0===i&&(i={}),"object"!=typeof t&&(t={method:t}),n.has(t,"method")||(t.method="GET"),r.Internals.Convoy({route:{controller:e},meta:t,payload:i})},r.Internals.Resource=function(e,t){return new Promise(function(i,o){if("undefined"==typeof e&&o(new r.Prototypes.Error({code:"Resource",message:"Resource path is not defined."},this)),n.has(r.Resources,e))r.Resources[e].success?i(r.Resources[e].data):r.Events.once("resource:"+e,i);else{r.Resources[e]={success:!1,data:null},r.Events.once("resource:"+e,i);var s={path:e,dataType:"text"};void 0!==t&&(s.elementId=t),r.Internals.Api("Resource",s,{}).done(function(t){r.Resources[e].success=!0,r.Resources[e].data=t,r.Events.trigger("resource:"+e,t)},o)}})},r.Internals.Compatibility=function(){var e=[];r.Client.android?e.push("android"):r.Client.ios?e.push("ios"):r.Client.mac?e.push("mac"):r.Client.windows?e.push("windows"):r.Client.linux?e.push("linux"):e.push("os"),r.Client.chrome?e.push("chrome"):r.Client.firefox?e.push("firefox"):r.Client.safari?e.push("safari"):r.Client.opera?e.push("opera"):r.Client.msie?e.push("msie"):r.Client.iphone?e.push("iphone"):e.push("browser"),r.Client.version&&e.push("version"+r.Client.version.split(".")[0]),r.Client.mobile?e.push("mobile"):e.push("desktop"),t("body").addClass(e.join(" "))},r.Internals.View=i.Model.extend({toObject:function(){return n.clone(this.attributes)},hydrate:function(){var e=this.get("el");if(this.set({uid:n.uniqueId("view_"),guid:"undefined"!=typeof e.dataAttr("guid")?e.dataAttr("guid"):null,entity:"undefined"!=typeof e.dataAttr("entity")?n.ucfirst(e.dataAttr("entity")):null,id:"undefined"!=typeof e.dataAttr("id")?e.dataAttr("id"):null,manifest:"undefined"!=typeof e.dataAttr("manifest")?e.dataAttr("manifest"):null,api:"undefined"!=typeof e.dataAttr("api")?e.dataAttr("api"):null,fetch:"undefined"==typeof e.dataAttr("fetch")||e.dataAttr("fetch"),target:"undefined"!=typeof e.dataAttr("target")?e.dataAttr("target"):null,prototype:"undefined"!=typeof e.dataAttr("prototype")?e.dataAttr("prototype"):null,autoSave:"undefined"!=typeof e.dataAttr("autoSave")?e.dataAttr("autoSave"):null,type:"undefined"!=typeof e.dataAttr("type")?e.dataAttr("type"):null,types:"undefined"!=typeof e.dataAttr("types")?e.dataAttr("types"):null,template:"undefined"!=typeof e.dataAttr("template")?e.dataAttr("template"):null,templates:"undefined"!=typeof e.dataAttr("templates")?e.dataAttr("templates"):null,dialogue:"undefined"!=typeof e.dataAttr("dialogue")?e.dataAttr("dialogue"):null,pagination:"undefined"!=typeof e.dataAttr("pagination")?e.dataAttr("pagination"):null,property:"undefined"!=typeof e.dataAttr("property")?e.dataAttr("property"):null,field:"undefined"!=typeof e.dataAttr("field")?e.dataAttr("field"):null,load:"undefined"!=typeof e.dataAttr("load")?e.dataAttr("load"):null,options:"undefined"!=typeof e.dataAttr("options")?e.dataAttr("options"):null,versionEntity:"undefined"!=typeof e.dataAttr("versionentity")?e.dataAttr("versionentity"):null,versionRouter:"undefined"!=typeof e.dataAttr("versionrouter")?e.dataAttr("versionrouter"):null,versionId:"undefined"!=typeof e.dataAttr("versionid")?e.dataAttr("versionid"):null,plugin:"undefined"!=typeof e.dataAttr("plugin")?e.dataAttr("plugin"):null,plugins:[]}),null!==this.get("plugin")){var t=this.get("plugin").split(" ");null!==this.get("type")?this.set("plugins",t.length>1?t:[this.get("plugin")]):t.length>1&&(this.set("plugin",n.first(t)),this.set("plugins",n.rest(t)))}var i=this.get("id"),o=null!==this.get("type")?this.get("type"):this.get("plugin"),s=null!==this.get("type")?"widgets":"plugins";this.set({scope:null!==i?"model":"collection",alias:null!==o?"stratus.views."+s+"."+o.toLowerCase():null,path:null!==o?o:null}),this.isNew()&&null!==this.get("entity")&&null!==this.get("manifest")&&this.set("scope","model")},clean:function(){this.has("entity")&&"none"!==this.get("entity").toLowerCase()||this.set({entity:null,scope:null})},nest:function(){var e={entity:this.get("entity"),id:this.get("id"),versionEntity:this.get("versionEntity"),versionRouter:this.get("versionRouter"),versionId:this.get("versionId"),scope:this.get("scope"),manifest:this.get("manifest")};return this.has(e.scope)&&(e[e.scope]=this.get(e.scope)),e},modelAttributes:function(){return{id:this.get("id")}}}),r.Internals.Loader=function(e,i,o){if("undefined"==typeof e){var s=t("body");e=s.dataAttr("loaded")?null:"[data-entity],[data-plugin]",e?s.dataAttr("loaded",!0):console.warn("Attempting to load Stratus root repeatedly!")}return e&&(e=i&&e&&"object"==typeof e?t(e).find("[data-type],[data-plugin]"):t(e)),new Promise(function(t,s){var a={total:e&&"object"==typeof e?e.length:0,iteration:0,views:{}};a.total>0?e.each(function(e,l){a.iteration++;var u=n.uniqueId("entry_");a.views[u]=!1,r.Internals.ViewLoader(l,i,o).done(function(e){a.views[u]=e,a.total===a.iteration&&n.allTrue(a.views)&&t(a)},s)}):t(a)})},r.Internals.ViewLoader=function(e,i,o){var s=i?i:null,a=!1,l=t(e);if(i=new r.Internals.View({el:l}),i.hydrate(),s&&(i.has("entity")?a=!0:i.set(s.nest())),i.clean(),!a){"undefined"==typeof o&&(o=["stratus"]);var u=i.get("template"),d=i.get("templates"),c=i.get("dialogue"),f=[];if(null!==i.get("scope")&&o.push("stratus."+i.get("scope")+"s.generic"),i.get("alias")&&n.has(requirejs.s.contexts._.config.paths,i.get("alias")))o.push(i.get("alias"));else if(i.get("path")){o.push(i.get("path"));var g=/(?=[^\/]*$)([a-zA-Z]+)/i,p=g.exec(i.get("path"));i.set("type",n.ucfirst(p[1]))}else i.set({type:null,alias:null,path:null});if(null!==u&&(d=n.extend(null!==d?d:{},{combined:u})),null!==c&&(d=n.extend(null!==d?d:{},{dialogue:c})),null!==d){for(var h in d)if(d.hasOwnProperty(h)&&"function"!=typeof d[h])if(0===d[h].indexOf("#")){var y=t(d[h]);y.length>0&&(d[h]=y.html())}else d[h]in requirejs.s.contexts._.config.paths?(o.push("text!"+d[h]),f.push(h)):(o.push("text!"+d[h]),f.push(h));i.set("templates",d),d=i.get("templates")}}return new Promise(function(e,t){return i.get("guid")?(r.Environment.get("production")||console.error("View hydration halted on",i.get("guid"),"due to repeat calls on the same element.",i.toObject()),e(!0),!0):a?(e(!0),!0):void require(o,function(s){!s.Environment.get("production")&&s.Environment.get("nestDebug")&&console.group("Stratus View");var r=0;if(d&&f.length>0)for(var a=0;a<arguments.length;a++)"string"==typeof arguments[a]&&(arguments[a].indexOf("<html")===-1?d[f[r]]=arguments[a]:console.error("Template",d[f[r]],"failed to load."),r++);i.set("templates",d),d=i.get("templates");var l=[];if(n.size(d)>0){var u=/<.+?data-type=["|'](.+?)["|'].*>/gi;n.each(d,function(e,t){if("string"==typeof e){if(e.search(u)!==-1)for(var o=u.exec(e);null!==o;){var r="stratus.views."+(i.get("plugin")?"plugins":"widgets")+"."+o[1].toLowerCase();r&&!n.has(requirejs.s.contexts._.config.paths,r)&&(s.Environment.get("production")||console.warn("Sub Type:",r,"not configured in require.js")),l.push(r),o=u.exec(e)}d[t]=n.template(e)}}),i.set("templates",d),d=i.get("templates")}i.get("plugins").length&&n.each(i.get("plugins"),function(e){l.push("stratus.views.plugins."+e.toLowerCase())});var c=[];null!==i.get("plugin")&&c.push("PluginLoader"),null!==i.get("type")&&c.push("WidgetLoader"),c.length||c.push("WidgetLoader"),n.each(c,function(r){0===n.size(l)?s.Internals[r](e,t,i,o):(o=n.union(o,l),new Promise(function(e,t){require(o,function(n){n.Internals[r](e,t,i,o)})}).done(e,t))})})})},r.Internals.WidgetLoader=function(e,t,i,o){if("model"===i.get("scope")){r.Models.has(i.get("entity"))||r.Models.set(i.get("entity"),r.Models.Generic.extend({}));var s,a,l=!1,u=r.Models.has(i.get("entity"))?r.Models.get(i.get("entity")):null;!i.get("id")&&i.get("manifest")?(a=i.get("entity")+"Manifest",s=r.Instances[a],s||(r.Instances[a]=new u,s=r.Instances[a],l=!0)):u&&n.has(u,"findOrCreate")?(s=u.findOrCreate(i.get("id")),s||(s=new u(i.modelAttributes()),l=!0)):(a=i.get("entity")+i.get("id"),s=r.Instances[a],s||(r.Instances[a]=new u(i.modelAttributes()),s=r.Instances[a],l=!0)),l&&s.safeInitialize(i.toObject()),i.set({model:s})}else if("collection"===i.get("scope")){r.Collections.has(i.get("entity"))||r.Collections.set(i.get("entity"),new r.Collections.Generic(i.toObject()));var d=r.Collections.get(i.get("entity"));!d.initialized&&i.get("fetch")&&d.safeInitialize(i.toObject()),i.set({collection:d})}if(null!==i.get("type")){var c=n.ucfirst(i.get("type"));if("undefined"!=typeof r.Views.Widgets[c]){var f=i.toObject();f.view=i,r.Instances[i.get("uid")]=new r.Views.Widgets[c](f),r.Instances[i.get("uid")].$el.attr("data-guid",i.get("uid")),n.has(r.Instances[i.get("uid")],"promise")?r.Instances[i.get("uid")].initializer.done(e,t):e(r.Instances[i.get("uid")])}else r.Environment.get("production")||console.warn("Stratus.Views.Widgets."+c+" is not correctly configured."),t(new r.Prototypes.Error({code:"WidgetLoader",message:"Stratus.Views.Widgets."+c+" is not correctly configured."},i.toObject()));!r.Environment.get("production")&&r.Environment.get("nestDebug")&&console.groupEnd()}else{var g=i.get("el").find("[data-type],[data-plugin]");g.length>0?r.Internals.Loader(i.get("el"),i,o).done(function(t){!r.Environment.get("production")&&r.Environment.get("nestDebug")&&console.groupEnd(),e(t)},function(e){!r.Environment.get("production")&&r.Environment.get("nestDebug")&&console.groupEnd(),t(new r.Prototypes.Error(e,g))}):!r.Environment.get("production")&&r.Environment.get("nestDebug")?(console.warn("No Innate or Nested Type Found:",i.toObject()),e(i.toObject()),console.groupEnd()):e(i.toObject())}},r.Internals.PluginLoader=function(e,t,i,o){var s=n.union([i.get("plugin")],i.get("plugins"));n.each(s,function(o){if(o=n.ucfirst(o),"undefined"!=typeof r.Views.Plugins[o]){var s=i.toObject();s.view=i,r.Instances[i.get("uid")]=new r.Views.Plugins[o](s),r.Instances[i.get("uid")].$el.attr("data-guid",i.get("uid")),n.has(r.Instances[i.get("uid")],"promise")?r.Instances[i.get("uid")].initializer.done(e,t):e(r.Instances[i.get("uid")])}else r.Environment.get("production")||console.warn("Stratus.Views.Plugins."+o+" is not correctly configured."),t(new r.Prototypes.Error({code:"PluginLoader",message:"Stratus.Views.Plugins."+o+" is not correctly configured."},i.toObject()))})},r.Internals.SetUrlParams=function(e,i){"undefined"==typeof i&&(i=window.location.href);var o={},s=i.indexOf("?");return i.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(e,t,n){o[t]=n}),o=n.extend(o,e),i=s>=0?i.substring(0,s):i,i+="?"+t.param(o)},r.PostMessage.Convoy=function(e){window.addEventListener("message",e,!1)},r.PostMessage.Convoy(function(e){if("https://auth.sitetheory.io"!==e.origin&&"http://admin.sitetheory.io"!==e.origin)return!1;var n=JSON.parse(e.data);n.meta.session&&n.meta.session!==t.cookie("SITETHEORY")&&(t.cookie("SITETHEORY",n.meta.session,{expires:365,path:"/"}),r.Client.safari||location.reload(!0))}),r.DOM.ready=function(e){"loading"!==document.readyState?e():document.addEventListener("DOMContentLoaded",e)},r.DOM.complete=function(e){"complete"===document.readyState?e():window.addEventListener("load",e)},r.DOM.unload=function(e){window.addEventListener("beforeunload",e)},r.Key.Enter=13,r.Key.Escape=27,n.extend(r.Events,i.Events),r.Events.on("initialize",function(){r.Environment.get("production")||(console.groupEnd(),console.group("Stratus Initialize")),r.Internals.Compatibility(),r.RegisterGroup=new r.Prototypes.Collection,require(["stratus.routers.generic"],function(){r.Routers.set("generic",new r.Routers.Generic),r.Instances[n.uniqueId("router.generic_")]=r.Routers.get("generic")}),r.Internals.Loader().done(function(e){r.Environment.get("production")||console.info("Views:",e),r.Events.on("finalize",function(e){i.History.started||i.history.start(),r.Events.trigger("finalized",e)}),r.Events.trigger("finalize",e)},function(e){console.error("Stratus Loader:",e)})}),r.Events.on("finalize",function(){r.Environment.get("production")||(console.groupEnd(),console.group("Stratus Finalize")),new r.Internals.Anchor,new r.Internals.LazyLoad,r.RegisterGroup.size&&r.RegisterGroup.each(function(e,t){n.has(r.Internals,t)&&r.Internals[t](e)})}),r.Events.on("terminate",function(){r.Environment.get("production")||(console.groupEnd(),console.group("Stratus Terminate"))}),r.Prototypes.Bootbox=function(e,t){e&&"object"==typeof e?(n.extend(this,e),this.message=this.message||"Message"):this.message=e||"Message",this.handler=this.handler||t,"function"!=typeof this.handler&&(this.handler=function(e){console.info("Client "+(void 0===e?"closed":e?"confirmed":"cancelled")+" dialog.")})},r.Events.on("alert",function(e,t){e instanceof r.Prototypes.Bootbox||(e=new r.Prototypes.Bootbox(e,t)),"undefined"!=typeof s?s.alert(e.message,e.handler):(alert(e.message),e.handler())}),r.Events.on("confirm",function(e,t){e instanceof r.Prototypes.Bootbox||(e=new r.Prototypes.Bootbox(e,t)),"undefined"!=typeof s?s.confirm(e.message,e.handler):t(confirm(e.message))}),r.Prototypes.Toast=function(e,t,i,o){e&&"object"==typeof e?(n.extend(this,e),this.message=this.message||"Message"):this.message=e||"Message",this.title=this.title||t||"Toast",this.priority=this.priority||i||"danger",this.settings=this.settings||o,this.settings&&"object"==typeof this.settings||(this.settings={}),this.settings.timeout=this.settings.timeout||1e4},r.Events.on("toast",function(e,n,i,o){e instanceof r.Prototypes.Toast||(e=new r.Prototypes.Toast(e,n,i,o)),"undefined"!=typeof t&&t.toaster?t.toaster(e):r.Events.trigger("alert",e.message)}),r.DOM.ready(function(){t("body").removeClass("loaded unloaded").addClass("loading"),r.Events.trigger("initialize")}),r.DOM.complete(function(){t("body").removeClass("loading unloaded").addClass("loaded")}),r.DOM.unload(function(e){t("body").removeClass("loading loaded").addClass("unloaded"),r.Events.trigger("terminate",e)}),r});