//     Stratus.Views.Widgets.Autocomplete.js 1.0
//     Copyright (c) 2016 by Sitetheory, All Rights Reserved
//
//     All information contained herein is, and remains the
//     property of Sitetheory and its suppliers, if any.
//     The intellectual and technical concepts contained herein
//     are proprietary to Sitetheory and its suppliers and may be
//     covered by U.S. and Foreign Patents, patents in process,
//     and are protected by trade secret or copyright law.
//     Dissemination of this information or reproduction of this
//     material is strictly forbidden unless prior written
//     permission is obtained from Sitetheory.
//
//     For full details and documentation:
//     http://docs.sitetheory.io
!function(e,t){"function"==typeof define&&define.amd?define(["stratus","jquery","underscore","stratus.views.widgets.base","selectize"],t):t(e.Stratus,e.$,e._)}(this,function(e,t,i){e.Views.Widgets.Autocomplete=e.Views.Widgets.Base.extend({model:e.Models.Generic,template:i.template('<div><span class="title"><span class="name">{{ (typeof model === "object" && model && _.has(model, "id")) ? model.id : "item" }}</span></span></div>'),url:"/Api/",options:{"private":{requiredCssFile:[e.BaseUrl+"sitetheorycore/css/sitetheory.selectize.css"],selectize:{preload:!0,delimiter:null,plugins:null,items:null,valueField:"id",labelField:"id",searchField:["id"],maxItems:1,create:!0,persist:!1,allowEmptyOption:!1},api:{limit:null}},"public":{target:null}},initialize:function(t){return this.$el.dataAttr("entity")&&this.$el.dataAttr("id")&&(this.options.forceType="model"),e.Views.Widgets.Base.prototype.initialize.call(this,t)},postOptions:function(e){null!==this.options.target&&(this.url="/Api/"+this.options.target+"/"),this.getDataOptions(this.options.selectize),this.options.selectize.render={option:function(e,t){return this.template({model:e,options:this.options,scope:"suggestion"})}.bind(this)},this.options.selectize.load=function(e,i){return e.length||this.initial.request?(this.initial.request=!1,void t.ajax({url:this.url+"?query="+e+"&"+t.param({options:this.options.api}),type:"GET",error:function(){i()},success:function(e){i(e.payload)}})):i()}.bind(this)},promise:function(t,s,n){i.contains(this.options.selectize.plugins,"drag_drop")?require(["jquery-ui"],function(){e.Views.Widgets.Base.prototype.promise.call(this,t,s,n)}.bind(this)):e.Views.Widgets.Base.prototype.promise.call(this,t,s,n)},storeElement:function(e){var t=this.$el;this.options.label&&(this.$el.append('<div class="autocomplete"></div>'),t=this.$el.find(".autocomplete")),t.selectize(this.options.selectize),this.initial=this.initial||{request:!0,load:!0},this.$element=t[0].selectize,this.registeredElement=!1},onRender:function(e){var t=this;return this.$element.on("load",function(){t.initial.load&&(t.initial.load=!1,null!==t.options.selectize.items&&t.options.selectize.items.length>0&&i.each(t.options.selectize.items,function(e){if(!i.has(this.options,e)){var s={};s[t.options.selectize.valueField]=e,s[t.options.selectize.labelField]=e,this.addOption(s)}this.setValue([e])},this),i.has(t,"selected")&&this.setValue(t.selected))}),!0},getValue:function(){if(!this.$element||"object"!=typeof this.$element||"undefined"!=typeof this.$element.length&&!this.$element.length)return!1;var e=[],t=this.$element.getValue();if(t=t.length?t.split(","):null){var s;i.each(t,function(t){s=parseInt(t),isNaN(s)||e.push({id:s})},e)}return e},setValue:function(e){if(!this.$element||"object"!=typeof this.$element||"undefined"!=typeof this.$element.length&&!this.$element.length)return!1;this.selected=[];var t="";return e&&e.length&&i.each(e,function(e){e&&"object"==typeof e&&i.has(e,"id")&&(t.length&&(t+=","),t+=e.id,this.selected.push(e.id))},this),this.$el.dataAttr("value",t),this.$element.setValue(this.selected),!0}})});