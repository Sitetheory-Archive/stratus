//     Stratus.Views.Widgets.Collection.js 1.0
//     Copyright (c) 2016 by Sitetheory, All Rights Reserved
//
//     All information contained herein is, and remains the
//     property of Sitetheory and its suppliers, if any.
//     The intellectual and technical concepts contained herein
//     are proprietary to Sitetheory and its suppliers and may be
//     covered by U.S. and Foreign Patents, patents in process,
//     and are protected by trade secret or copyright law.
//     Dissemination of this information or reproduction of this
//     material is strictly forbidden unless prior written
//     permission is obtained from Sitetheory.
//
//     For full details and documentation:
//     http://docs.sitetheory.io
!function(t,e){"function"==typeof define&&define.amd?define(["stratus","jquery","underscore","masonry","sortable","stratus.views.widgets.base","stratus.views.widgets.generic"],e):e(t.Stratus,t.$,t._,t.Masonry,t.Sortable)}(this,function(t,e,i,s,o){t.Views.Widgets.Collection=t.Views.Widgets.Base.extend({template:i.template('<div data-collection="{{ globals.uid }}" data-entity="{{ globals.entity }}" data-id="{{ model.id }}"></div>'),errorTemplate:i.template('{% if (collection.meta.has("api.q")) { %}<div class="{{ options.cssNoResults}}"><div class="message">{{ options.textNoResults }}</div><div class="icon"></div></div>{% } else if (typeof code === "string") { %}<div class="{{ options.cssError}}"><div class="message">An Internal Error (Code: {{ code }}) occurred.  Please notify support with the url and time of the error.</div><div class="icon"></div></div>{% } else { %}<div class="{{ options.cssNoContent }}"><div class="message">{{ options.textNoContent }}</div><div class="icon"></div></div>{% } %}'),events:{"keypress #newGeneric":"createOnEnter",start:"dragStart",end:"dragEnd"},templateRender:"container",options:{"private":{api:{limit:null},autoLoader:!1},"public":{source:null,limit:null,batch:null,phantoms:null,width:null,height:null,meta:null,success:null,error:null,add:null,change:null,destroy:null,rerender:null,resync:null,masonry:null,sortable:null,standalone:!1,textNoResults:"We were unable to find any content matching your request.",cssNoResults:"empty",textNoContent:"No content available.",cssError:"error",cssNoContent:"empty"}},handled:!1,promise:function(t,e,s){if(this.templates=i.has(t,"templates")?t.templates:null,this.entity=i.has(t,"entity")?t.entity:null,i.has(this.options,"rerender")){var o=["success","error","add","change","destroy"],n=i.isArray(this.options.rerender)||i.isObject(this.options.rerender)?i.clone(this.options.rerender):null,l=n?"none":this.options.rerender;i.each(o,function(t){this.options[t]=l},this),n&&i.each(n,function(t,e){t&&(i.isObject(t)?i.each(t,function(t,e){this.options[e]=t},this):i.isString(e)?this.options[e]=t:this.options[t]="all")},this),"none"===this.options.rerender&&(this.options.success="none",this.options.error="none",this.options.add="none",this.options.change="none",this.options.destroy="none")}this.collection&&"object"==typeof this.collection?this.handleCollection():this.model&&"object"==typeof this.model&&this.handleProperty(),this.views={},this.once("render",function(t){e(t)})},postOptions:function(t){this.options.limit&&(this.options.api.limit=this.options.limit)},primeAdd:function(t,e){this.options.add&&"all"!==this.options.add?"one"===this.options.add||"none"===this.options.add?this.collection.size()>1?(this.buildGlobals(t),this.addOne(t)):this.addAll():console.warn("Add Event contains unknown option:",this.options.add):this.addAll()},primeReset:function(t,e){this.addAll()},primeSuccess:function(e,i){console.log("Success:",this.options.success,e instanceof t.Collections.Generic&&"collection"===this.options.success||e instanceof t.Models.Generic&&"model"===this.options.success,e),this.options.success&&"all"!==this.options.success?(e instanceof t.Collections.Generic&&"collection"===this.options.success||e instanceof t.Models.Generic&&"model"===this.options.success)&&this.addAll():this.addAll()},primeError:function(t,e){},primeChange:function(t,e){this.options.change&&"all"!==this.options.change&&(!i.has(e,"xhr")||this.options.success&&"all"!==this.options.success)||this.addAll()},primeDestroy:function(t,e,i){this.options.destroy||this.addAll()},modelTarget:function(){var t={entity:this.model.entity,id:"id"};return"string"==typeof this.propertyName&&-1!==this.propertyName.indexOf(".")&&(t.entity=i.first(this.propertyName.split(".")),this.model.has(t.entity+".id")?t.id=t.entity+".id":t.entity=this.model.entity),{entity:i.ucfirst(t.entity),id:this.model.get(t.id)}},handleProperty:function(){this.collection=new t.Collections.Generic({entity:i.ucfirst(this.options.source),target:this.modelTarget(),initialize:!0,api:{property:this.propertyName}}),t.Instances[this.collection.globals.get("uid")]=this.collection,"string"==typeof this.propertyName&&this.model.on("change:"+this.propertyName,function(){this.model.once("success",function(){this.model.once("change",function(){this.collection.target=this.modelTarget(),this.collection.refresh({reset:!0})},this)},this)},this),this.handleCollection()},handleCollection:function(){return this.handled?!1:(this.handled=!0,this.collection.on("reset",this.primeReset,this),this.collection.on("success",this.primeSuccess,this),this.collection.on("error",this.primeError,this),this.collection.on("add",this.primeAdd,this),this.collection.on("change",this.primeChange,this),void this.collection.on("destroy",this.primeDestroy,this))},clearGlobals:function(t){i.each(this.collection.globals.get("levels"),function(t,e,i){this.collection.globals.set("level"+t,0),this.collection.globals.set("total"+t,0)},this),i.each(this.collection.globals.get("parents"),function(t,e,i){this.collection.globals.set("parent"+t,0),this.collection.globals.set("parentTotal"+t,0)},this)},buildGlobals:function(e){var i=e.has("level")?e.get("level"):1;this.collection.globals.iterate("total"+i),e.has("parent")&&null!==t.Relations.Sanitize(e,"parent","id")&&this.collection.globals.iterate("parentTotal"+t.Relations.Sanitize(e,"parent","id"))},drag:function(){},onError:function(t,e,s){return i.has(e,"status")&&200!==e.status&&this.$el.html(this.errorTemplate({collection:this.collection,options:this.options,code:e.status.toString()})),!0},addOne:function(s){var n=s.has("parent")&&null!==t.Relations.Sanitize(s,"parent","id"),l=0,a={parent:n?t.Relations.Sanitize(s,"parent","id"):0,child:n,level:s.has("level")?s.get("level"):1,iteration:0,total:0,phantom:!1,last:!1,entity:this.collection.globals.get("entity"),meta:this.options.meta,hook:this.el,uid:this.collection.globals.get("uid"),weight:0,gravity:0,compound:0};if(a.iteration=this.collection.globals.iterate("level"+a.level),a.total=this.collection.globals.get("total"+a.level),a.last=a.iteration===a.total,i.has(this.templates,"combined")||i.has(this.templates,"list")){var c=this.$el.find('[data-hook="containers"]');c.length>0&&(a.hook=c)}if(this.options.batch){var r=a.iteration%this.options.batch;1===r?(a.iteration=1,this.collection.globals.set("batchParent",s.get("id")),this.collection.globals.set("parent"+s.get("id"),1)):(a.parent=this.collection.globals.get("batchParent"),a.child=!0),0===r&&(a.last=!0),0!==r&&a.last&&(l=this.options.batch-r,a.last=!1)}if(this.collection.globals.add("levels",a.level),this.collection.globals.add("parents",a.parent),a.child){a.iteration=this.collection.globals.iterate("parent"+a.parent),a.total=this.collection.globals.get("parentTotal"+a.parent),a.last=a.iteration===a.total;var h='[data-collection="'+a.uid+'"][data-entity="'+a.entity+'"][data-hook="parent'+a.parent+'"]';e(h).length>0&&(a.hook=h)}a.weight=1/a.total,a.gravity=a.weight*a.iteration,a.compound=1/(a.total-1)*(a.iteration-1),e(a.hook).append(this.template({scope:"container",globals:a,meta:this.collection.meta.toObject(),model:s.attributes})),this.collection.globals.iterate("modelNumber");var d,p=s.has("id")?s.get("id"):this.collection.globals.get("modelNumber");i.has(this.views,p)&&(d=this.views[p].guid,this.views[p].destroy(),t.Instances.Clean(d));var u=new t.Internals.View(i.extend({},this.view.nest(),{uid:a.uid,id:s.get("id"),scope:"model",model:s,collection:this.collection})),g=i.extend({},u.toObject(),{collectionView:this,globals:a,templates:this.templates,type:"generic",rerender:{change:this.options.change},view:u,style:this.options.style});if(d=i.uniqueId(this.entity+"_generic"),this.views[p]=t.Instances[d]=new t.Views.Widgets.Generic(g),this.views[p].guid=d,a.child&&a.last&&o.create(i.first(e(a.hook)),{draggable:".draggable",group:this.entity}),l&&i.has(this.templates,"entity")){var m=i.clone(a);m.iteration=this.options.batch-m.iteration,m.model=null,m.phantom=!0,m.parent=this.collection.globals.get("batchParent"),m.child=!0,m.hook='[data-collection="'+a.uid+'"][data-entity="'+m.entity+'"][data-hook="parent'+m.parent+'"]';for(var v=this.templates.combined||this.templates.entity,y=0;l>y;y++)m.iteration++,y===l-1&&(m.last=!0),e(m.hook).append(v({scope:"entity",globals:m}))}this.collection.globals.get("lastLevel")>a.level&&this.collection.globals.set("level"+this.collection.globals.get("lastLevel"),0),this.collection.globals.set("lastLevel",a.level)},addAll:function(){var e={scope:"list",collection:this.collection,options:this.options};this.$el.html(i.has(this.templates,"combined")?this.templates.combined(e):i.has(this.templates,"list")?this.templates.list(e):""),this.$el.html()&&this.$el.html().trim().length||this.collection.size()||this.$el.html(this.errorTemplate({collection:this.collection,options:this.options})),this.$el.html()&&this.$el.html().trim().length&&t.Internals.Loader(this.el,this.view).done(function(t){},function(t){console.error("List Views:",t)}),this.options.autosort&&this.collection.sort(),this.clearGlobals(),this.collection.models.forEach(this.buildGlobals,this),this.collection.models.forEach(this.addOne,this),this.options.masonry&&new s(this.el,{itemSelector:".grid-item",columnWidth:160,percentPosition:!0}),this.options.sortable&&o.create(this.el,{group:this.entity}),this.trigger("render",this)},dragStart:function(t){console.log("Start:",t.originalEvent)},dragEnd:function(s){var o=e(s.originalEvent.item);o=o.dataAttr("id")?o:o.find("[data-id]");var n={el:o,id:o.data("id"),entity:o.data("entity"),priority:i.size(this.collection.models)-s.originalEvent.newIndex,reference:t.Models.Generic};n.entity&&n.id&&(n.reference=t.Models.get(n.entity).findOrCreate(n.id),n.reference.save("priority",n.priority),this.collection.refresh()),console.log("End:",s.originalEvent.newIndex,n)}})});