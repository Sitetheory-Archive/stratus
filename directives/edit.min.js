!function(root,factory){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","stratus.services.model"],factory):factory(root.Stratus,root._)}(this,function(Stratus,_){Stratus.Directives.Edit=function($parse,$log,model){return{restrict:"A",require:"ngModel",scope:{ngModel:"=",property:"@",emptyValue:"@",prefix:"@",stratusEdit:"=",alwaysEdit:"@",autoSave:"@"},link:function($scope,$element,$attrs,ngModel){if($scope.uid=this.uid=_.uniqueId("edit_"),Stratus.Instances[this.uid]=$scope,$scope.model=null,$scope.value=$element.html(),!ngModel||!$scope.property)return void console.warn($scope.uid+" has no model or property!");var ctrl={initialized:!1};ngModel.$render=function(){$element.html(($scope.prefix||"")+($scope.value||$scope.emptyValue||""))},$scope.liveEditStatus=function(){if(ctrl.initialized){if(void 0!==$scope.stratusEdit)return $scope.stratusEdit;if(void 0!==Stratus.Environment.data.liveEdit)return Stratus.Environment.data.liveEdit;console.warn($scope.uid+" has no variable to track edit toggle! ($scope.stratusEdit)")}return!1},$scope.read=function(){ctrl.initialized&&($scope.value=$element.html(),$scope.prefix&&($scope.value=$scope.value.replace($scope.prefix,"")))},$scope.accept=function(){ctrl.initialized&&$scope.model instanceof model&&$scope.property&&$scope.model.get($scope.property)!==$scope.value&&($scope.model.set($scope.property,$scope.value),$scope.model.save())},$scope.cancel=function(){ctrl.initialized&&$scope.model instanceof model&&$scope.property&&($scope.value=$scope.model.get($scope.property))},$scope.$watch("ngModel",function(data){if(data instanceof model&&!_.isEqual(data,$scope.model)){$scope.model=data;var unwatch=$scope.$watch("model.data",function(){unwatch(),ctrl.init()})}}),ctrl.init=function(){ctrl.initialized||(ctrl.initialized=!0,$scope.$watch("model.data."+$scope.property,function(data){$scope.value=data,ngModel.$render()}),$scope.alwaysEdit!==!0&&"true"!==$scope.alwaysEdit?$scope.$watch($scope.liveEditStatus,function(liveEdit){$element.attr("contenteditable",liveEdit),liveEdit?$element.addClass("liveEdit"):$element.removeClass("liveEdit")}):$element.attr("contenteditable",!0),$element.on("focusout keyup change",function(){if(ctrl.initialized&&($scope.$apply($scope.read),$scope.autoSave!==!1&&"false"!==$scope.autoSave))switch(event.type){case"focusout":case"blur":$scope.$apply($scope.accept)}}),$element.on("keydown keypress",function(event){if(ctrl.initialized)switch(event.which){case Stratus.Key.Enter:event.preventDefault(),$scope.autoSave!==!1&&"false"!==$scope.autoSave&&$scope.$apply($scope.accept);break;case Stratus.Key.Escape:$scope.$apply($scope.cancel)}}))}}}}});