(function(root,factory){if(typeof define==="function"&&define.amd){define(["stratus","underscore","angular","stratus.services.model"],factory)}else{factory(root.Stratus,root._)}})(this,function(Stratus,_){Stratus.Directives.Edit=function($parse,$log,model){return{restrict:"A",require:"ngModel",scope:{ngModel:"=",property:"@",emptyValue:"@",stratusEdit:"=",alwaysEdit:"@",autoSave:"@"},link:function($scope,$element,$attrs,ngModel){$scope.uid=this.uid=_.uniqueId("edit_");Stratus.Instances[this.uid]=$scope;$scope.model=null;$scope.value=null;if(!ngModel||!$scope.property){console.warn($scope.uid+" has no model or property!");return}ngModel.$render=function(){$element.html($scope.value||$scope.emptyValue||"")};$scope.liveEditStatus=function(){if($scope.stratusEdit!==undefined){return $scope.stratusEdit}else if(Stratus.Environment.data.liveEdit!==undefined){return Stratus.Environment.data.liveEdit}console.warn($scope.uid+" has no variable to track edit toggle! ($scope.stratusEdit)");return false};$scope.read=function(){$scope.value=$element.html()};$scope.accept=function(){if($scope.model instanceof model&&$scope.property){$scope.model.set($scope.property,$scope.value);$scope.model.save()}};$scope.cancel=function(){if($scope.model instanceof model&&$scope.property){$scope.value=$scope.model.get($scope.property)}};if($scope.alwaysEdit!==true&&$scope.alwaysEdit!=="true"){$scope.$watch($scope.liveEditStatus,function(liveEdit){$element.attr("contenteditable",liveEdit);if(liveEdit){$element.addClass("liveEdit")}else{$element.removeClass("liveEdit")}})}else{$element.attr("contenteditable",true)}$scope.$watch("ngModel",function(data){if(data instanceof model&&!_.isEqual(data,$scope.model)){$scope.model=data}});$scope.$watch("model.data."+$scope.property,function(data){$scope.value=data;ngModel.$render()});$element.on("focusout keyup change",function(){$scope.$apply($scope.read);if($scope.autoSave!==false&&$scope.autoSave!=="false"){switch(event.type){case"focusout":case"blur":$scope.$apply($scope.accept);break}}});$element.on("keydown keypress",function(event){switch(event.which){case Stratus.Key.Enter:event.preventDefault();if($scope.autoSave!==false&&$scope.autoSave!=="false"){$scope.$apply($scope.accept)}break;case Stratus.Key.Escape:$scope.$apply($scope.cancel);break}})}}}});