!function(root,factory){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","stratus.services.registry","stratus.services.model","stratus.services.collection","angular-material","stratus.services.socialLibraries"],factory):factory(root.Stratus,root._,root.angular)}(this,function(Stratus,_,angular){const min=Stratus.Environment.get("production")?".min":"";Stratus.Components.SingleSignOn={bindings:{},controller:function($rootScope,$scope,$window,$attrs,$http,$mdDialog,socialLibraries,Model){this.uid=_.uniqueId(_.camelToSnake("singleSignOn")+"_"),Stratus.Instances[this.uid]=$scope,$scope.elementId=$attrs.elementId||this.uid,Stratus.Internals.CssLoader(Stratus.BaseUrl+Stratus.BundlePath+"components/singleSignOn"+min+".css"),$scope.initialized=!1,socialLibraries.loadGGLibrary(),socialLibraries.loadFacebookSDK(),$scope.layout="row";let data=null;function getFBProfileBasic(){FB.api("/me?fields=id,name,email,picture",function(response){apiLogin(response,"facebook",!0)},{scope:["name","email","picture"]})}function requireEmail(socialName,response){data=response,$scope.$parent.requireEmail(socialName,data)}function apiLogin(data,service,truthData){new Model({target:"Login"},{service:service,data:data,truthData:truthData}).save().then(function(data){Stratus.Environment.get("production")||console.log("Successful login:",data)}).catch(function(error,response){let status=response.meta&&_.isArray(response.meta.status)&&response.meta.status.length?_.first(response.meta.status):null;"CREDENTIALS"===status.code?(data.message=status.message,requireEmail(service,response)):console.error(error)})}window.checkLoginState=function(){FB.getLoginStatus(function(response){switch(console.log("loginStatus:",response),response.status){case"connected":case"not_authorized":getFBProfileBasic();break;default:FB.login(function(response){null!==response.authResponse?getFBProfileBasic():FB.login()},{scope:["name","email","picture"]})}})},$scope.$on("doSocialSignup",function(event,email){data.email=email,Stratus.Environment.get("production")||console.log("SocialSignup:",event,email,data),apiLogin(data,"facebook",!1)}),window.onbeforeunload=function(e){gapi.auth2.getAuthInstance().signOut()},window.onSignIn=function(googleUser){let profile=googleUser.getBasicProfile(),data={email:profile.getEmail(),name:profile.getName(),id:profile.getId(),picture:profile.getImageUrl()};Stratus.Environment.get("production")||console.log("Google:",data),apiLogin(data,"google",!0)}},templateUrl:Stratus.BaseUrl+Stratus.BundlePath+"components/singleSignOn"+min+".html"}});