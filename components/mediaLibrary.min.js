!function(root,factory){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","angular-material","angular-file-upload","stratus.components.search","stratus.components.pagination","stratus.components.mediaDetails","stratus.directives.singleClick","stratus.directives.src","stratus.services.registry","stratus.services.commonMethods","stratus.services.media"],factory):factory(root.Stratus,root._)}(this,function(Stratus,_){Stratus.Modules.ngFileUpload=!0,Stratus.Components.MediaLibrary={bindings:{ngModel:"=",target:"@",limit:"@",data:"&"},controller:function($scope,$http,$attrs,$parse,$element,Upload,$compile,registry,$mdPanel,$q,$mdDialog,commonMethods,media,$rootElement){commonMethods.componentInitializer(this,$scope,$attrs,"media_library",!0),$scope.registry=new registry,$scope.registry.fetch({target:$attrs.target||"Media",id:null,manifest:!1,decouple:!0,api:{limit:_.isJSON($attrs.limit)?JSON.parse($attrs.limit):30}},$scope),$scope.showLibrary=!1,$scope.files=[],$scope.tagsModel={},$scope.infoId=null,$scope.$watch("tagsModel",function(data){if(void 0!==$scope.infoId){var dataRes={};dataRes.tags=$scope.tagsModel.tags,$scope.updateMedia($scope.infoId,dataRes)}},!0),$scope.uploadComp=!1,$scope.movedFileId="",$scope.errorUpload=!1,$scope.libraryVisible=!0,$scope.showDetails=function(media){$mdDialog.show({attachTo:angular.element(document.querySelector("#listContainer")),controller:DialogShowDetails,template:'<stratus-media-details media="data"></stratus-media-details>',clickOutsideToClose:!0,focusOnOpen:!0,autoWrap:!0,locals:{data:media}})};var DialogShowDetails=function($scope,data){$scope.data=data,$scope.close=function(){$mdDialog.cancel()}};$scope.zoomView=function(event){$scope.mediaDetail=event,$scope.selectedName={name:$scope.mediaDetail.name,editing:!1},$scope.selectedDesc={description:$scope.mediaDetail.description,editing:!1};var position=$mdPanel.newPanelPosition().absolute().center(),config={attachTo:angular.element(document.body),scope:$scope,disableParentScroll:this.disableParentScroll,controller:ZoomController,templateUrl:"mediaDetail.html",hasBackdrop:!0,panelClass:"media-dialog",position:position,trapFocus:!0,zIndex:150,clickOutsideToClose:!1,escapeToClose:!0,focusOnOpen:!0};$mdPanel.open(config),$scope.tagsModel.tags=$scope.mediaDetail.tags,$scope.infoId=$scope.mediaDetail.id,$scope.imageSrc=$scope.mediaDetail.url},$scope.draggedFileId="",$scope.imageMoved=!1,$scope.dragClass=!1,$scope.deleteFromMedia=function(fileId){Stratus.Environment.get("production")||console.log(fileId);var confirmMedia=$mdDialog.confirm().title("DELETE MEDIA").textContent("Are you sure you want to permanently delete this from your library? You may get broken images if any content still uses this image.").ok("Yes").cancel("No");$mdDialog.show(confirmMedia).then(function(){$http({method:"DELETE",url:"/Api/Media/"+fileId}).then(function(response){$scope.uploadMedia()},function(rejection){Stratus.Environment.get("production")||console.log(rejection.data)})})},$scope.uploadToLibrary=function(files){files.length>0&&($("#main").addClass("blurred"),$(".drag-drop").addClass("show-overlay"),$mdDialog.show({controller:media.DialogController,locals:{files:files},templateUrl:Stratus.BaseUrl+"sitetheorystratus/stratus/components/mediaDragDropDialog"+(Stratus.Environment.get("production")?".min":"")+".html",parent:angular.element(document.body),clickOutsideToClose:!1,escapeToClose:!1,focusOnOpen:!0}).then(function(answer){$scope.files=$scope.files.concat(files)},function(){}))},$scope.editItem=function(item){item.editing=!0},$scope.doneEditing=function(fileId,item){var data={};item.description&&(data.description=item.description),item.name&&(data.name=item.name),$scope.updateMedia(fileId,data),item.editing=!1},$scope.updateMedia=function(fileId,data){$http({method:"PUT",url:"/Api/Media/"+fileId,data:data}).then(function(response){$scope.uploadMedia()},function(rejection){Stratus.Environment.get("production")||console.log(rejection.data)})},$scope.$watch("files",function(files){if(null!==files){if($scope.dragClass=!1,!angular.isArray(files))return void $timeout(function(){$scope.files=files=[files]});for(var promises=[],i=0;i<files.length;i++)$scope.errorMsg=null,f=files[i],!1===$scope.imageMoved&&promises.push($scope.saveMedia(f));promises.length>0&&$q.all(promises).then(function(data){$scope.uploadComp=!0,$scope.uploadMedia()}).catch(function(error){$scope.uploadComp=!0})}var f}),$scope.uploadMedia=function(){$scope.collection.fetch().then(function(response){})};$scope.createTag=function(query,fileId,tags){var data={name:query};media.createTag(data).then(function(response){if(void 0!==fileId&&void 0!==tags){var dataRes={};$scope.tagsModel.tags.push(response.data.payload),dataRes.tags=$scope.tagsModel.tags,$scope.updateMedia(fileId,dataRes)}},function(rejection){Stratus.Environment.get("production")||console.log(rejection.data)})},$scope.saveMedia=function(file){return Stratus.Environment.get("production")||console.log(["savemedia"],file),file.errorMsg=null,file.uploadStatus=!1,file.errorUpload=!1,file.upload=media.uploadToS3(file),file.upload.then(function(response){file.result=response.data,file.uploadStatus=!0,file.errorUpload=!1,$scope.infoId=null,$scope.imageSrc=file.result.url},function(rejection){!0===rejection.config.data.file.upload.aborted?(file.uploadStatus=!1,file.errorUpload=!0,file.errorMsg="Aborted"):(file.uploadStatus=!1,file.errorUpload=!0,file.errorMsg="Server Error! Please try again")}),file.upload.progress(function(evt){file.progress=Math.min(100,parseInt(100*evt.loaded/evt.total))}),file.upload},$scope.addClassOnPopup=function(event){angular.element(document.querySelector($(event.target).attr("data-target"))).addClass($(event.target).attr("data-class"))};function ZoomController(mdPanelRef){$scope.deleteMediaFromLibrary=function(fileId){mdPanelRef.close(),$scope.deleteFromMedia(fileId)},$scope.closeZoom=function(){$scope.infoId=null,mdPanelRef.close()}}},templateUrl:Stratus.BaseUrl+"sitetheorystratus/stratus/components/mediaLibrary"+(Stratus.Environment.get("production")?".min":"")+".html"}});