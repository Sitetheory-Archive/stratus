!function(root,factory){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","angular-material","angular-file-upload","stratus.components.search","stratus.components.pagination","stratus.components.mediaDetails","stratus.directives.singleClick","stratus.directives.src","stratus.services.registry","stratus.services.commonMethods","stratus.services.media"],factory):factory(root.Stratus,root._)}(this,function(Stratus,_){Stratus.Modules.ngFileUpload=!0,Stratus.Components.MediaLibrary={bindings:{ngModel:"=",target:"@",limit:"@",data:"&"},controller:function($scope,$http,$attrs,$parse,$element,Upload,$compile,registry,$mdPanel,$q,$mdDialog,commonMethods,media,$rootElement){commonMethods.componentInitializer(this,$scope,$attrs,"media_library",!0);var $ctrl=this;$ctrl.uploadToLibrary=uploadToLibrary,$ctrl.showDetails=function(media){$mdDialog.show({attachTo:angular.element(document.querySelector("#listContainer")),controller:function($scope,media,collection){$scope.media=media,$scope.collection=collection,$scope.uploadToLibrary=function(files){uploadToLibrary(files)}},template:'<stratus-media-details media="media" collection="collection"></stratus-media-details>',clickOutsideToClose:!0,focusOnOpen:!0,autoWrap:!0,locals:{media:media,collection:$scope.collection}})},$ctrl.deleteFromMedia=function(fileId){Stratus.Environment.get("production")||console.log(fileId);$mdDialog.show($mdDialog.confirm().title("DELETE MEDIA").textContent("Are you sure you want to permanently delete this from your library? You may get broken images if any content still uses this image.").multiple(!0).ok("Yes").cancel("No")).then(function(){media.deleteMedia(fileId).then(function(response){commonMethods.getStatus(response).code==commonMethods.RESPONSE_CODE().success?media.getMedia($scope):$mdDialog.show($mdDialog.alert().parent(angular.element(document.querySelector("#popupContainer"))).clickOutsideToClose(!1).title("Error").multiple(!0).textContent(commonMethods.getStatus(response).message).ok("Ok"))},function(rejection){Stratus.Environment.get("production")||console.log(rejection.data)})})},$ctrl.registry=new registry,$ctrl.registry.fetch({target:$attrs.target||"Media",id:null,manifest:!1,decouple:!0,api:{limit:_.isJSON($attrs.limit)?JSON.parse($attrs.limit):30}},$scope),$ctrl.files=[],$ctrl.tagsModel={},$ctrl.infoId=null,$scope.$watch("tagsModel",function(data){if(void 0!==$ctrl.infoId){var dataRes={};dataRes.tags=$ctrl.tagsModel.tags,media.updateMedia($ctrl.infoId,dataRes).then(function(response){media.getMedia($scope)},function(rejection){Stratus.Environment.get("production")||console.log(rejection.data)})}},!0),$scope.$watch("files",function(newFiles,oldFiles){null!==newFiles&&newFiles!=oldFiles&&preProcessOfSavingMedia(_.difference(newFiles,oldFiles))}),$ctrl.uploadComp=!1;function uploadToLibrary(files){if(files.length>0){$("#main").addClass("blurred"),$(".drag-drop").addClass("show-overlay"),$scope.files=files,$mdDialog.show({controller:function($scope,files){$scope.files=files,$scope.uploadComp=!1,$scope.done=function(){$mdDialog.hide(),media.dragleave()},$scope.cancel=function(){$mdDialog.cancel(),media.dragleave()},$scope.abort=function(){console.log("aborted")},$scope.addFiles=function(newFiles){newFiles.length>0&&($scope.files=Array.from($scope.files).concat(newFiles))},$scope.removeFiles=function(file){$scope.files=_.without($scope.files,file)},$scope.$watch("files",function(newFiles,oldFiles){null!==newFiles&&newFiles!=oldFiles&&preProcessOfSavingMedia(_.difference(newFiles,oldFiles))})},locals:{files:files},templateUrl:Stratus.BaseUrl+"sitetheorystratus/stratus/components/mediaDragDropDialog"+(Stratus.Environment.get("production")?".min":"")+".html",parent:angular.element(document.body),clickOutsideToClose:!1,escapeToClose:!1,focusOnOpen:!0,multiple:!0}).then(function(answer){$ctrl.files=$ctrl.files.concat(files)},function(){})}}function preProcessOfSavingMedia(files){if(angular.isArray(files)){for(var promises=[],i=0;i<files.length;i++)$scope.errorMsg=null,promises.push(saveMedia(files[i]));promises.length>0&&($q.all(promises).then(function(response){media.getMedia($scope)},function(error){console.log(error)}),$ctrl.uploadComp=!0)}else $timeout(function(){$scope.files=files=[files]})}function saveMedia(file){return file.errorMsg=null,file.uploadStatus=!1,file.errorUpload=!1,file.progress=1,file.upload=media.uploadToS3(file,$ctrl.infoId),file.upload.then(function(response){file.result=response.data,file.uploadStatus=!0,file.errorUpload=!1,$ctrl.infoId=null,$ctrl.imageSrc=file.result.url},function(rejection){!0===rejection.config.data.file.upload.aborted?(file.uploadStatus=!1,file.errorUpload=!0,file.errorMsg="Aborted"):(file.uploadStatus=!1,file.errorUpload=!0,file.errorMsg="Server Error! Please try again")}),file.upload.progress(function(evt){file.progress=Math.min(100,parseInt(100*evt.loaded/evt.total))}),file.upload}},templateUrl:Stratus.BaseUrl+"sitetheorystratus/stratus/components/mediaLibrary"+(Stratus.Environment.get("production")?".min":"")+".html"}});