//     Stratus.Components.mediaSelector.js 1.0
//     Copyright (c) 2016 by Sitetheory, All Rights Reserved
//
//     All information contained herein is, and remains the
//     property of Sitetheory and its suppliers, if any.
//     The intellectual and technical concepts contained herein
//     are proprietary to Sitetheory and its suppliers and may be
//     covered by U.S. and Foreign Patents, patents in process,
//     and are protected by trade secret or copyright law.
//     Dissemination of $scope information or reproduction of $scope
//     material is strictly forbidden unless prior written
//     permission is obtained from Sitetheory.
//
//     For full details and documentation:
//     http://docs.sitetheory.io
!function(root,factory){"function"==typeof define&&define.amd?define(["stratus","jquery","angular","jquery-cookie","angular-file-upload","stratus.services.registry","angular-material","stratus.components.search","stratus.components.pagination"],factory):factory(root.Stratus,root.$)}(this,function(Stratus,$){Stratus.Modules.ngFileUpload=!0,Stratus.Components.MediaSelector={bindings:{ngModel:"="},controller:function($scope,$http,$attrs,$parse,$element,Upload,$compile,registry,$mdPanel,$q){Stratus.Instances[_.uniqueId("media_selector")]=$scope,Stratus.Internals.CssLoader(Stratus.BaseUrl+"sitetheorystratus/stratus/components/mediaSelector"+(Stratus.Environment.get("production")?".min":"")+".css"),$scope.registry=new registry,$scope.registry.fetch("Media",$scope),$scope.showLibrary=!1,$scope.showDragDropLibrary=!1,$scope.draggedFiles=[],$scope.files=[],$scope.showLibraryClass="fa fa-plus-square-o",$scope.dragDropClass="fa fa-plus",$scope.zoomView=function(event){$scope.mediaDetail=event;var position=$mdPanel.newPanelPosition().absolute().center(),config={attachTo:angular.element(document.body),scope:$scope,disableParentScroll:this.disableParentScroll,templateUrl:"mediaDetail.html",hasBackdrop:!0,panelClass:"media-dialog",position:position,trapFocus:!0,zIndex:150,clickOutsideToClose:!0,escapeToClose:!0,focusOnOpen:!0};$mdPanel.open(config)},$scope.uploadFiles=function(files){$scope.showLibrary=!1;var position=$mdPanel.newPanelPosition().absolute().center(),config={attachTo:angular.element(document.body),scope:$scope,disableParentScroll:this.disableParentScroll,templateUrl:"uploadedFiles.html",hasBackdrop:!0,panelClass:"media-dialog",position:position,trapFocus:!0,zIndex:150,clickOutsideToClose:!0,escapeToClose:!0,focusOnOpen:!0};$mdPanel.open(config),"fa fa-minus"===$scope.dragDropClass&&($scope.showDragDropLibrary=!0)},$scope.uploadToLibrary=function(files){var promises=[];angular.forEach(files,function(file){promises.push($scope.saveMedia(file))}),$q.all(promises).then(function(data){$scope.uploadMedia()})},$scope.openLibrary=function(){"fa fa-plus-square-o"===$scope.showLibraryClass?($scope.showLibraryClass="fa fa-minus-square-o",$scope.showLibrary=!0,$scope.showDragDropLibrary=!1,$scope.dragDropClass="fa fa-plus","fa fa-plus"===$scope.dragDropClass?$scope.dragDropClass="fa fa-minus":$scope.dragDropClass="fa fa-plus",$scope.uploadMedia()):"fa fa-minus-square-o"===$scope.showLibraryClass&&($scope.showLibraryClass="fa fa-plus-square-o",$scope.showLibrary=!1)},$scope.mediaLibrary=function(){"fa fa-plus"===$scope.dragDropClass?($scope.dragDropClass="fa fa-minus",$scope.showLibrary=!1,$scope.showDragDropLibrary=!0,$scope.uploadMedia()):"fa fa-minus"===$scope.dragDropClass&&($scope.dragDropClass="fa fa-plus",$scope.showDragDropLibrary=!1)},$scope.uploadMedia=function(){$scope.collection.fetch()},$scope.$watch("files",function(files){if(null!=files){if(!angular.isArray(files))return void $timeout(function(){$scope.files=files=[files]});for(var i=0;i<files.length;i++)$scope.errorMsg=null,function(f){$scope.saveMedia(f)}(files[i])}}),$scope.saveMedia=function(file){file.upload=Upload.upload({url:"https://app.sitetheory.io:3000/?session="+$.cookie("SITETHEORY"),data:{file:file}}),file.upload.then(function(response){file.result=response.data,$scope.draggedFiles.push(response.data)},function(response){response.status>0&&($scope.errorMsg=response.status+": "+response.data)}),file.upload.progress(function(evt){file.progress=Math.min(100,parseInt(100*evt.loaded/evt.total))})}},templateUrl:Stratus.BaseUrl+"sitetheorystratus/stratus/components/mediaSelector"+(Stratus.Environment.get("production")?".min":"")+".html"}});