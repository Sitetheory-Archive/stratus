!function(t,e){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","angular-material","stratus.services.model"],e):e(t.Stratus,t._)}(this,function(t,e){t.Services.Collection=["$provide",function(n){n.factory("collection",["$q","$http","$mdToast","$timeout","model",function(n,i,o,a,r){return function(a){this.target=null,this.infinite=!1,this.threshold=.5,this.qualifier="",this.decay=0,a&&"object"==typeof a&&angular.extend(this,a),this.urlRoot="/Api",this.models=[],this.meta=new t.Prototypes.Model,this.model=r,this.pending=!1,this.error=!1,this.completed=!1,this.filtering=!1,this.paginate=!1,this.target&&(this.urlRoot+="/"+e.ucfirst(this.target));var s=this;this.serialize=function(t,e){var n=[];return t=t||{},angular.forEach(t,function(t,i){if(angular.isObject(t))e&&(i=e+"["+i+"]"),n.push(s.serialize(t,i));else{var o="";e&&(o+=e+"["),o+=i,e&&(o+="]"),n.push(o+"="+t)}}),n.join("&")},this.url=function(){return s.urlRoot},this.inject=function(t,n){e.isArray(t)&&t.forEach(function(t){s.models.push(new r({collection:s,type:n||null},t))})},this.sync=function(t,o){return s.pending=!0,s.completed=!1,n(function(n,a){var r={method:t=t||"GET",url:s.url(),headers:{}};angular.isDefined(o)&&("GET"===t?angular.isObject(o)&&Object.keys(o).length&&(r.url+="?"+s.serialize(o)):(r.headers["Content-Type"]="application/json",r.data=JSON.stringify(o))),i(r).then(function(t){if(200===t.status&&angular.isObject(t.data)){s.meta.set(t.data.meta||{}),s.models=[];var i=t.data.payload||t.data;e.isArray(i)?s.inject(i):e.isObject(i)?e.each(i,s.inject):console.error("malformatted payload:",i),s.pending=!1,s.completed=!0,s.filtering=!1,s.paginate=!1,n(s.models)}else s.pending=!1,s.error=!0,a(t.statusText&&"OK"!==t.statusText?t.statusText:angular.isObject(t.data)?t.data:"Invalid Payload: "+r.method+" "+r.url)}).catch(function(){a("XHR: "+r.method+" "+r.url)})})},this.fetch=function(t,e){return s.sync(t,e||s.meta.get("api")).catch(function(t){o.show(o.simple().textContent("Failure to Fetch!").toastClass("errorMessage").position("top right").hideDelay(3e3)),console.error("FETCH:",t)})},this.filter=function(t){return s.filtering=!0,s.meta.set("api.q",angular.isDefined(t)?t:""),s.meta.set("api.p",1),s.fetch()},this.throttle=e.throttle(this.fetch,1e3),this.throttleFilter=function(i){return s.meta.set("api.q",angular.isDefined(i)?i:""),n(function(n,i){var o=s.throttle();t.Environment.get("production")||console.log("request:",o),o.then(function(i){t.Environment.get("production")||console.log("throttled:",e.map(i,function(t){return t.domainPrimary})),n(i)}).catch(i)})},this.page=function(t){s.paginate=!0,s.meta.set("api.p",t),s.fetch(),delete s.meta.get("api").p},this.toJSON=function(){var t=[];return s.models.forEach(function(e){"function"==typeof e.toJSON&&t.push(e.toJSON())}),t},this.add=function(t,e){e&&"object"==typeof e||(e={}),angular.isObject(t)&&(t=t instanceof r?t:new r({collection:s},t),s.models.push(t),e.save&&t.save())},this.remove=function(t){s.models.splice(s.models.indexOf(t),1)},this.pluck=function(t){return e.map(s.models,function(e){return e instanceof r?e.pluck(t):null})},this.exists=function(t){return!!e.reduce(s.pluck(t)||[],function(t,e){return t||angular.isDefined(e)})}}}])}]});