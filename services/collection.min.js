!function(t,e){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","angular-material","stratus.services.model"],e):e(t.Stratus,t._)}(this,function(s,u){s.Services.Collection=["$provide",function(t){t.factory("Collection",["$q","$http","$mdToast","$timeout","Model",function(i,r,n,t,o){return function(t){this.target=null,this.direct=!1,this.infinite=!1,this.threshold=.5,this.qualifier="",this.decay=0,t&&"object"==typeof t&&angular.extend(this,t),this.urlRoot="/Api",this.models=[],this.meta=new s.Prototypes.Model,this.model=o,this.pending=!1,this.error=!1,this.completed=!1,this.filtering=!1,this.paginate=!1,this.target&&(this.urlRoot+="/"+u.ucfirst(this.target));var a=this;this.serialize=function(t,n){var o=[];return t=t||{},angular.forEach(t,function(t,e){if(angular.isObject(t))n&&(e=n+"["+e+"]"),o.push(a.serialize(t,e));else{var i="";n&&(i+=n+"["),i+=e,n&&(i+="]"),o.push(i+"="+t)}}),o.join("&")},this.url=function(){return a.urlRoot},this.inject=function(t,e){!a.direct&&u.isArray(t)&&t.forEach(function(t){a.models.push(new o({collection:a,type:e||null},t))})},this.sync=function(t,e){return a.pending=!0,a.completed=!1,i(function(i,n){var o={method:t=t||"GET",url:a.url(),headers:{}};angular.isDefined(e)&&("GET"===t?angular.isObject(e)&&Object.keys(e).length&&(o.url+="?"+a.serialize(e)):(o.headers["Content-Type"]="application/json",o.data=JSON.stringify(e))),r(o).then(function(t){if(200===t.status&&angular.isObject(t.data)){a.meta.set(t.data.meta||{}),a.models=[];var e=t.data.payload||t.data;u.isArray(e)?a.inject(e):u.isObject(e)?u.each(e,a.inject):console.error("malformed payload:",e),a.pending=!1,a.completed=!0,a.filtering=!1,a.paginate=!1,i(a.direct?e:a.models)}else a.pending=!1,a.error=!0,n(t.statusText&&"OK"!==t.statusText?t.statusText:angular.isObject(t.data)?t.data:"Invalid Payload: "+o.method+" "+o.url)}).catch(function(){n("XHR: "+o.method+" "+o.url)})})},this.fetch=function(t,e){return a.sync(t,e||a.meta.get("api")).catch(function(t){n.show(n.simple().textContent("Failure to Fetch!").toastClass("errorMessage").position("top right").hideDelay(3e3)),console.error("FETCH:",t)})},this.filter=function(t){return a.filtering=!0,a.meta.set("api.q",angular.isDefined(t)?t:""),a.meta.set("api.p",1),a.fetch()},this.throttle=u.throttle(this.fetch,1e3),this.throttleFilter=function(t){return a.meta.set("api.q",angular.isDefined(t)?t:""),i(function(e,t){var i=a.throttle();s.Environment.get("production")||console.log("request:",i),i.then(function(t){s.Environment.get("production"),e(t)}).catch(t)})},this.page=function(t){a.paginate=!0,a.meta.set("api.p",t),a.fetch(),delete a.meta.get("api").p},this.toJSON=function(){var e=[];return a.models.forEach(function(t){"function"==typeof t.toJSON&&e.push(t.toJSON())}),e},this.add=function(t,e){e&&"object"==typeof e||(e={}),angular.isObject(t)&&(t=t instanceof o?t:new o({collection:a},t),a.models.push(t),e.save&&t.save())},this.remove=function(t){a.models.splice(a.models.indexOf(t),1)},this.pluck=function(e){return u.map(a.models,function(t){return t instanceof o?t.pluck(e):null})},this.exists=function(t){return!!u.reduce(a.pluck(t)||[],function(t,e){return t||angular.isDefined(e)})}}}])}]});