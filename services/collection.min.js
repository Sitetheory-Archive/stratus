!function(t,e){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","angular-material","stratus.services.model"],e):e(t.Stratus,t._,t.angular)}(this,function(a,c,u){a.Services.Collection=["$provide",function(t){t.factory("Collection",["$q","$http","$mdToast","$timeout","Model",function(i,r,n,t,o){return function(t){this.target=null,this.direct=!1,this.infinite=!1,this.threshold=.5,this.qualifier="",this.decay=0,this.urlRoot="/Api",t&&"object"==typeof t&&u.extend(this,t),this.models=[],this.meta=new a.Prototypes.Model,this.model=o,this.pending=!1,this.error=!1,this.completed=!1,this.filtering=!1,this.paginate=!1,this.target&&(this.urlRoot+="/"+c.ucfirst(this.target));var s=this;this.serialize=function(t,n){var o=[];return t=t||{},u.forEach(t,function(t,e){if(u.isObject(t))n&&(e=n+"["+e+"]"),o.push(s.serialize(t,e));else{var i="";n&&(i+=n+"["),i+=e,n&&(i+="]"),o.push(i+"="+t)}}),o.join("&")},this.url=function(){return s.urlRoot+(s.targetSuffix||"")},this.inject=function(t,e){c.isArray(t)&&t.forEach(function(t){s.models.push(new o({collection:s,type:e||null},t))})},this.sync=function(t,e){return s.pending=!0,s.completed=!1,i(function(i,n){var o={method:t=t||"GET",url:s.url(),headers:{}};u.isDefined(e)&&("GET"===t?u.isObject(e)&&Object.keys(e).length&&(o.url+="?"+s.serialize(e)):(o.headers["Content-Type"]="application/json",o.data=JSON.stringify(e))),r(o).then(function(t){if(200===t.status&&u.isObject(t.data)){s.meta.set(t.data.meta||{}),s.models=[];var e=t.data.payload||t.data;s.direct?s.models=e:c.isArray(e)?s.inject(e):c.isObject(e)?c.each(e,s.inject):console.error("malformed payload:",e),s.pending=!1,s.completed=!0,s.filtering=!1,s.paginate=!1,i(s.models)}else s.pending=!1,s.error=!0,n(t.statusText&&"OK"!==t.statusText?t.statusText:u.isObject(t.data)?t.data:"Invalid Payload: "+o.method+" "+o.url)}).catch(function(){n("XHR: "+o.method+" "+o.url)})})},this.fetch=function(t,e){return s.sync(t,e||s.meta.get("api")).catch(function(t){n.show(n.simple().textContent("Failure to Fetch!").toastClass("errorMessage").position("top right").hideDelay(3e3)),console.error("FETCH:",t)})},this.filter=function(t){return s.filtering=!0,s.meta.set("api.q",u.isDefined(t)?t:""),s.meta.set("api.p",1),s.fetch()},this.throttle=c.throttle(this.fetch,1e3),this.throttleFilter=function(t){return s.meta.set("api.q",u.isDefined(t)?t:""),i(function(e,t){var i=s.throttle();a.Environment.get("production")||console.log("request:",i),i.then(function(t){a.Environment.get("production"),e(t)}).catch(t)})},this.page=function(t){s.paginate=!0,s.meta.set("api.p",t),s.fetch(),delete s.meta.get("api").p},this.toJSON=function(){var e=[];return s.models.forEach(function(t){"function"==typeof t.toJSON&&e.push(t.toJSON())}),e},this.add=function(t,e){e&&"object"==typeof e||(e={}),u.isObject(t)&&(t=t instanceof o?t:new o({collection:s},t),s.models.push(t),e.save&&t.save())},this.remove=function(t){s.models.splice(s.models.indexOf(t),1)},this.pluck=function(e){return c.map(s.models,function(t){return t instanceof o?t.pluck(e):null})},this.exists=function(t){return!!c.reduce(s.pluck(t)||[],function(t,e){return t||u.isDefined(e)})}}}])}]});