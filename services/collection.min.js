!function(root,factory){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","angular-material","stratus.services.model"],factory):factory(root.Stratus,root._,root.angular)}(this,function(Stratus,_,angular){Stratus.Services.Collection=["$provide","$qProvider",function($provide,$qProvider){$qProvider.errorOnUnhandledRejections(!1),$provide.factory("Collection",["$q","$http","$mdToast","$timeout","$log","Model",function($q,$http,$mdToast,$timeout,$log,Model){return function(options){this.target=null,this.direct=!1,this.infinite=!1,this.threshold=.5,this.qualifier="",this.decay=0,this.urlRoot="/Api",options&&"object"==typeof options&&angular.extend(this,options),this.header=new Stratus.Prototypes.Model,this.meta=new Stratus.Prototypes.Model,this.model=Model,this.models=[],this.types=[],this.pending=!1,this.error=!1,this.completed=!1,this.filtering=!1,this.paginate=!1,this.target&&(this.urlRoot+="/"+_.ucfirst(this.target));var that=this;this.serialize=function(obj,chain){var str=[];return obj=obj||{},angular.forEach(obj,function(value,key){if(angular.isObject(value))chain&&(key=chain+"["+key+"]"),str.push(that.serialize(value,key));else{var encoded="";chain&&(encoded+=chain+"["),encoded+=key,chain&&(encoded+="]"),str.push(encoded+"="+value)}}),str.join("&")},this.url=function(){return that.urlRoot+(that.targetSuffix||"")},this.inject=function(data,type){_.isArray(data)&&(-1===that.types.indexOf(type)&&that.types.push(type),data.forEach(function(target){that.models.push(new Model({collection:that,type:type||null},target))}))},this.sync=function(action,data,options){return that.pending=!0,that.completed=!1,$q(function(resolve,reject){action=action||"GET",options=options||{};var prototype={method:action,url:that.url(),headers:{}};angular.isDefined(data)&&("GET"===action?angular.isObject(data)&&Object.keys(data).length&&(prototype.url.includes("?")?prototype.url+="&":prototype.url+="?",prototype.url+=that.serialize(data)):(prototype.headers["Content-Type"]="application/json",prototype.data=JSON.stringify(data))),options.hasOwnProperty("headers")&&"object"==typeof options.headers&&Object.keys(options.headers).forEach(function(headerKey){prototype.headers[headerKey]=options.headers[headerKey]}),$http(prototype).then(function(response){if(200===response.status&&angular.isObject(response.data)){that.header.set(response.headers()||{}),that.meta.set(response.data.meta||{}),that.models=[];var data=response.data.payload||response.data;that.direct?that.models=data:_.isArray(data)?that.inject(data):_.isObject(data)?_.each(data,that.inject):$log.error("malformed payload:",data),that.pending=!1,that.completed=!0,that.filtering=!1,that.paginate=!1,resolve(that.models)}else that.pending=!1,that.error=!0,reject(response.statusText&&"OK"!==response.statusText?response.statusText:angular.isObject(response.data)?response.data:"Invalid Payload: "+prototype.method+" "+prototype.url)}).catch(function(){reject("XHR: "+prototype.method+" "+prototype.url)})})},this.fetch=function(action,data,options){return that.sync(action,data||that.meta.get("api"),options).catch(function(message){$mdToast.show($mdToast.simple().textContent("Failure to Fetch!").toastClass("errorMessage").position("top right").hideDelay(3e3)),$log.error("FETCH:",message)})},this.filter=function(query){return that.filtering=!0,that.meta.set("api.q",angular.isDefined(query)?query:""),that.meta.set("api.p",1),that.fetch()},this.throttle=_.throttle(this.fetch,1e3),this.throttleFilter=function(query){return that.meta.set("api.q",angular.isDefined(query)?query:""),$q(function(resolve,reject){var request=that.throttle();Stratus.Environment.get("production")||$log.log("request:",request),request.then(function(models){Stratus.Environment.get("production"),resolve(models)}).catch(reject)})},this.page=function(page){that.paginate=!0,that.meta.set("api.p",page),that.fetch(),delete that.meta.get("api").p},this.toJSON=function(){var sanitized=[];return that.models.forEach(function(model){"function"==typeof model.toJSON&&sanitized.push(model.toJSON())}),sanitized},this.add=function(target,options){options&&"object"==typeof options||(options={}),angular.isObject(target)&&(target=target instanceof Model?target:new Model({collection:that},target),that.models.push(target),options.save&&target.save())},this.remove=function(target){that.models.splice(that.models.indexOf(target),1)},this.pluck=function(attribute){return _.map(that.models,function(element){return element instanceof Model?element.pluck(attribute):null})},this.exists=function(attribute){return!!_.reduce(that.pluck(attribute)||[],function(memo,data){return memo||angular.isDefined(data)})}}}])}]});