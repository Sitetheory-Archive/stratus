!function(root,factory){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","stratus.services.model"],factory):factory(root.Stratus,root._)}(this,function(Stratus,_){Stratus.Services.Collection=["$provide",function($provide){$provide.factory("collection",function($q,$http,$timeout,model){return function(options){this.target=null,this.infinite=!1,this.threshold=.5,this.qualifier="",this.decay=0,options&&"object"==typeof options&&angular.extend(this,options),this.urlRoot="/Api",this.models=[],this.meta=new Stratus.Prototypes.Collection,this.model=model,this.pending=!1,this.error=!1,this.completed=!1,this.paginate=!1,this.target&&(this.urlRoot+="/"+_.ucfirst(this.target));var that=this;this.serialize=function(obj,chain){var str=[];return obj=obj||{},angular.forEach(obj,function(value,key){if(angular.isObject(value))str.push(that.serialize(value,key));else{var encoded="";chain&&(encoded+=chain+"["),encoded+=key,chain&&(encoded+="]"),str.push(encoded+"="+value)}}),str.join("&")},this.url=function(){return that.urlRoot},this.sync=function(action,data){return this.pending=!0,$q(function(resolve,reject){action=action||"GET";var prototype={method:action,url:that.url(),headers:{}};angular.isDefined(data)&&("GET"===action?angular.isObject(data)&&Object.keys(data).length&&(prototype.url+="?"+that.serialize(data)):(prototype.headers["Content-Type"]="application/json",prototype.data=JSON.stringify(data))),$http(prototype).then(function(response){if("200"==response.status){that.meta.set(response.data.meta||{}),that.models=[];var data=response.data.payload||response.data;angular.isArray(data)&&data.forEach(function(target){that.models.push(new model({collection:that},target))}),that.pending=!1,that.completed=!0,that.paginate=!1,resolve(response.data.payload)}else that.pending=!1,that.error=!0,reject(response)},reject)})},this.fetch=function(action,data){return that.sync(action,data||that.meta.get("api"))},this.filter=function(query){return that.meta.set("api.q",angular.isDefined(query)?query:""),that.fetch()},this.page=function(page){return that.paginate=!0,that.meta.set("api.p",page),that.fetch()},this.toJSON=function(){var sanitized=[];return that.models.forEach(function(model){"function"==typeof model.toJSON&&sanitized.push(model.toJSON())}),sanitized},this.add=function(target,options){options&&"object"==typeof options||(options={}),angular.isObject(target)&&(target=target instanceof model?target:new model({collection:that},target),that.models.push(target),options.save&&target.save())},this.remove=function(target){that.models.splice(that.models.indexOf(target),1)}}})}]});