!function(t,e){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","angular-material","stratus.services.model"],e):e(t.Stratus,t._,t.angular)}(this,function(t,e,i){t.Services.Collection=["$provide","$qProvider",function(n,s){s.errorOnUnhandledRejections(!1),n.factory("Collection",["$q","$http","$mdToast","$timeout","$log","Model",function(n,s,o,r,a,c){return function(r){this.target=null,this.direct=!1,this.infinite=!1,this.threshold=.5,this.qualifier="",this.decay=0,this.urlRoot="/Api",r&&"object"==typeof r&&i.extend(this,r),this.header=new t.Prototypes.Model,this.meta=new t.Prototypes.Model,this.model=c,this.models=[],this.types=[],this.pending=!1,this.error=!1,this.completed=!1,this.filtering=!1,this.paginate=!1,this.target&&(this.urlRoot+="/"+e.ucfirst(this.target));var u=this;this.serialize=function(t,e){var n=[];return t=t||{},i.forEach(t,function(t,s){if(i.isObject(t))e&&(s=e+"["+s+"]"),n.push(u.serialize(t,s));else{var o="";e&&(o+=e+"["),o+=s,e&&(o+="]"),n.push(o+"="+t)}}),n.join("&")},this.url=function(){return u.urlRoot+(u.targetSuffix||"")},this.inject=function(t,i){e.isArray(t)&&(-1===u.types.indexOf(i)&&u.types.push(i),t.forEach(function(t){u.models.push(new c({collection:u,type:i||null},t))}))},this.sync=function(t,o){return u.pending=!0,u.completed=!1,n(function(n,r){var c={method:t=t||"GET",url:u.url(),headers:{}};i.isDefined(o)&&("GET"===t?i.isObject(o)&&Object.keys(o).length&&(c.url+="?"+u.serialize(o)):(c.headers["Content-Type"]="application/json",c.data=JSON.stringify(o))),s(c).then(function(t){if(200===t.status&&i.isObject(t.data)){u.header.set(t.headers()||{}),u.meta.set(t.data.meta||{}),u.models=[];var s=t.data.payload||t.data;u.direct?u.models=s:e.isArray(s)?u.inject(s):e.isObject(s)?e.each(s,u.inject):a.error("malformed payload:",s),u.pending=!1,u.completed=!0,u.filtering=!1,u.paginate=!1,n(u.models)}else u.pending=!1,u.error=!0,r(t.statusText&&"OK"!==t.statusText?t.statusText:i.isObject(t.data)?t.data:"Invalid Payload: "+c.method+" "+c.url)}).catch(function(){r("XHR: "+c.method+" "+c.url)})})},this.fetch=function(t,e){return u.sync(t,e||u.meta.get("api")).catch(function(t){o.show(o.simple().textContent("Failure to Fetch!").toastClass("errorMessage").position("top right").hideDelay(3e3)),a.error("FETCH:",t)})},this.filter=function(t){return u.filtering=!0,u.meta.set("api.q",i.isDefined(t)?t:""),u.meta.set("api.p",1),u.fetch()},this.throttle=e.throttle(this.fetch,1e3),this.throttleFilter=function(e){return u.meta.set("api.q",i.isDefined(e)?e:""),n(function(e,i){var n=u.throttle();t.Environment.get("production")||a.log("request:",n),n.then(function(i){t.Environment.get("production"),e(i)}).catch(i)})},this.page=function(t){u.paginate=!0,u.meta.set("api.p",t),u.fetch(),delete u.meta.get("api").p},this.toJSON=function(){var t=[];return u.models.forEach(function(e){"function"==typeof e.toJSON&&t.push(e.toJSON())}),t},this.add=function(t,e){e&&"object"==typeof e||(e={}),i.isObject(t)&&(t=t instanceof c?t:new c({collection:u},t),u.models.push(t),e.save&&t.save())},this.remove=function(t){u.models.splice(u.models.indexOf(t),1)},this.pluck=function(t){return e.map(u.models,function(e){return e instanceof c?e.pluck(t):null})},this.exists=function(t){return!!e.reduce(u.pluck(t)||[],function(t,e){return t||i.isDefined(e)})}}}])}]});