!function(t,e){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","angular-material","stratus.services.model"],e):e(t.Stratus,t._,t.angular)}(this,function(t,e,i){t.Services.Collection=["$provide",function(n){n.factory("Collection",["$http","$mdToast","$timeout","$log","Model",function(n,s,o,r,a){return function(o){this.target=null,this.direct=!1,this.infinite=!1,this.threshold=.5,this.qualifier="",this.decay=0,this.urlRoot="/Api",o&&"object"==typeof o&&i.extend(this,o),this.header=new t.Prototypes.Model,this.meta=new t.Prototypes.Model,this.model=a,this.models=[],this.types=[],this.pending=!1,this.error=!1,this.completed=!1,this.filtering=!1,this.paginate=!1,this.target&&(this.urlRoot+="/"+e.ucfirst(this.target));var c=this;this.serialize=function(t,e){var n=[];return t=t||{},i.forEach(t,function(t,s){if(i.isObject(t))e&&(s=e+"["+s+"]"),n.push(c.serialize(t,s));else{var o="";e&&(o+=e+"["),o+=s,e&&(o+="]"),n.push(o+"="+t)}}),n.join("&")},this.url=function(){return c.urlRoot+(c.targetSuffix||"")},this.inject=function(t,i){e.isArray(t)&&(-1===c.types.indexOf(i)&&c.types.push(i),t.forEach(function(t){c.models.push(new a({collection:c,type:i||null},t))}))},this.sync=function(t,s,o){return c.pending=!0,c.completed=!1,new Promise(function(a,u){o=o||{};var h={method:t=t||"GET",url:c.url(),headers:{}};i.isDefined(s)&&("GET"===t?i.isObject(s)&&Object.keys(s).length&&(h.url.includes("?")?h.url+="&":h.url+="?",h.url+=c.serialize(s)):(h.headers["Content-Type"]="application/json",h.data=JSON.stringify(s))),o.hasOwnProperty("headers")&&"object"==typeof o.headers&&Object.keys(o.headers).forEach(function(t){h.headers[t]=o.headers[t]}),n(h).then(function(t){if(200===t.status&&i.isObject(t.data)){c.header.set(t.headers()||{}),c.meta.set(t.data.meta||{}),c.models=[];var n=t.data.payload||t.data;c.direct?c.models=n:e.isArray(n)?c.inject(n):e.isObject(n)?e.each(n,c.inject):r.error("malformed payload:",n),c.pending=!1,c.completed=!0,c.filtering=!1,c.paginate=!1,a(c.models)}else c.pending=!1,c.error=!0,u(t.statusText&&"OK"!==t.statusText?t.statusText:i.isObject(t.data)?t.data:"Invalid Payload: "+h.method+" "+h.url)}).catch(function(){u("XHR: "+h.method+" "+h.url)})})},this.fetch=function(t,e,i){return c.sync(t,e||c.meta.get("api"),i).catch(function(t){s.show(s.simple().textContent("Failure to Fetch!").toastClass("errorMessage").position("top right").hideDelay(3e3)),r.error("FETCH:",t)})},this.filter=function(t){return c.filtering=!0,c.meta.set("api.q",i.isDefined(t)?t:""),c.meta.set("api.p",1),c.fetch()},this.throttle=e.throttle(this.fetch,1e3),this.throttleFilter=function(e){return c.meta.set("api.q",i.isDefined(e)?e:""),new Promise(function(e,i){var n=c.throttle();t.Environment.get("production")||r.log("request:",n),n.then(function(i){t.Environment.get("production"),e(i)}).catch(i)})},this.page=function(t){c.paginate=!0,c.meta.set("api.p",t),c.fetch(),delete c.meta.get("api").p},this.toJSON=function(){var t=[];return c.models.forEach(function(e){"function"==typeof e.toJSON&&t.push(e.toJSON())}),t},this.add=function(t,e){e&&"object"==typeof e||(e={}),i.isObject(t)&&(t=t instanceof a?t:new a({collection:c},t),c.models.push(t),e.save&&t.save())},this.remove=function(t){c.models.splice(c.models.indexOf(t),1)},this.find=function(t){return e.find(c.models,e.isFunction(t)?t:function(e){return e.get("id")===t})},this.pluck=function(t){return e.map(c.models,function(e){return e instanceof a?e.pluck(t):null})},this.exists=function(t){return!!e.reduce(c.pluck(t)||[],function(t,e){return t||i.isDefined(e)})}}}])}]});