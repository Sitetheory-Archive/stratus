//     Stratus.services.collection.js 1.0
//     Copyright (c) 2016 by Sitetheory, All Rights Reserved
//
//     All information contained herein is, and remains the
//     property of Sitetheory and its suppliers, if any.
//     The intellectual and technical concepts contained herein
//     are proprietary to Sitetheory and its suppliers and may be
//     covered by U.S. and Foreign Patents, patents in process,
//     and are protected by trade secret or copyright law.
//     Dissemination of this information or reproduction of this
//     material is strictly forbidden unless prior written
//     permission is obtained from Sitetheory.
//
//     For full details and documentation:
//     http://docs.sitetheory.io
!function(t,e){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","stratus.services.model"],e):e(t.Stratus,t._)}(this,function(t,e){t.Services.Collection=["$provide",function(i){i.factory("collection",function(i,n,a,r){return function(a){this.target=null,this.infinite=!1,this.threshold=.5,this.qualifier="",this.decay=0,a&&"object"==typeof a&&angular.extend(this,a),this.urlRoot="/Api",this.models=[],this.meta=new t.Prototypes.Collection,this.model=r,this.pending=!1,this.error=!1,this.completed=!1,this.paginate=!1,this.target&&(this.urlRoot+="/"+e.ucfirst(this.target));var o=this;this.serialize=function(t,e){var i=[];return t=t||{},angular.forEach(t,function(t,n){if(angular.isObject(t))i.push(o.serialize(t,n));else{var a="";e&&(a+=e+"["),a+=n,e&&(a+="]"),i.push(a+"="+t)}}),i.join("&")},this.url=function(){return o.urlRoot},this.sync=function(t,e){return this.pending=!0,i(function(i,a){t=t||"GET";var r={method:t,url:o.url(),headers:{action:t}};angular.isDefined(e)&&("GET"===t?angular.isObject(e)&&Object.keys(e).length&&(r.url+="?"+o.serialize(e)):(r.headers["Content-Type"]="application/json",r.data=JSON.stringify(e))),n(r).then(function(t){if("200"==t.status){o.meta.set(t.data.meta),o.models=[];var e=t.data.payload||t.data;angular.isArray(e)&&e.forEach(function(t){o.models.push(new o.model({target:o.target},t))}),o.pending=!1,o.completed=!0,o.paginate=!1,i(o.models)}else o.pending=!1,o.error=!0,a(t)},a)})},this.fetch=function(t,e){return o.sync(t,e||o.meta.get("api"))},this.filter=function(t){return o.meta.set("api.q",t),o.fetch()},this.page=function(t){return o.paginate=!0,o.meta.set("api.p",t),o.fetch()},this.toJSON=function(){var t=[];return o.models.forEach(function(e){"function"==typeof e.toJSON&&t.push(e.toJSON())}),t},this.add=function(t){angular.isObject(t)&&o.models.push(t instanceof r?t:new o.model({target:o.target},t))},this.remove=function(t){console.log("remove:",t)}}})}]});