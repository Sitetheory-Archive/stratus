!function(t,a){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","stratus.services.collection","stratus.services.model"],a):a(t.Stratus,t._)}(this,function(t,a){t.Services.Registry=["$provide",function(e){e.factory("Registry",["Collection","Model","$interpolate","$q",function(e,i,n,r){return function(){this.fetch=function(t,e){var i=this;return new r(function(r,o){angular.isString(t)&&(t={target:t});var l={target:t.attr?t.attr("data-target"):t.target,id:t.attr?t.attr("data-id"):t.id,manifest:t.attr?t.attr("data-manifest"):t.manifest,decouple:t.attr?t.attr("data-decouple"):t.decouple,api:t.attr?t.attr("data-api"):t.api},c=0;e.$watch(function(){return c},function(t){a.isNumber(t)&&parseInt(t)===a.size(l)&&r(i.build(l,e))}),a.each(l,function(t,a){if(t&&angular.isString(t)){var i=n(t,!1,null,!0),r=i(e.$parent);angular.isDefined(r)?(l[a]=r,c++):e.$watch(function(){return i(e.$parent)},function(t){t&&(l[a]=t,c++)})}else c++})})},this.build=function(n,r){var o;if(n.target){if(n.target=a.ucfirst(n.target),n.manifest||n.id){t.Catalog[n.target]||(t.Catalog[n.target]={});var l=n.id||"manifest";n.decouple||!t.Catalog[n.target][l]?(o=new i({target:n.target,manifest:n.manifest,stagger:!0},{id:n.id}),n.decouple||(t.Catalog[n.target][l]=o)):t.Catalog[n.target][l]&&(o=t.Catalog[n.target][l])}else t.Catalog[n.target]||(t.Catalog[n.target]={}),n.decouple||!t.Catalog[n.target].collection?(o=new e({target:n.target}),n.decouple||(t.Catalog[n.target].collection=o)):t.Catalog[n.target].collection&&(o=t.Catalog[n.target].collection);n.api&&o.meta.set("api",a.isJSON(n.api)?JSON.parse(n.api):n.api),o.stagger&&"function"==typeof o.initialize&&o.initialize()}return angular.isObject(o)&&(void 0!==r&&(r.data=o,o instanceof i?r.model=o:o instanceof e&&(r.collection=o)),o.pending||o.completed||o.fetch()),o}}}])}]});