!function(t,a){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","stratus.services.collection","stratus.services.model"],a):a(t.Stratus,t._)}(this,function(o,l){o.Services.Registry=["$provide",function(t){t.factory("Registry",["collection","model","$interpolate","$q",function(n,r,c,t){return function(){this.fetch=function(e,o){var i=this;return new t(function(a,t){angular.isString(e)&&(e={target:e});var n={target:e.attr?e.attr("data-target"):e.target,id:e.attr?e.attr("data-id"):e.id,manifest:e.attr?e.attr("data-manifest"):e.manifest,decouple:e.attr?e.attr("data-decouple"):e.decouple,api:e.attr?e.attr("data-api"):e.api},r=0;o.$watch(function(){return r},function(t){l.isNumber(t)&&parseInt(t)===l.size(n)&&a(i.build(n,o))}),l.each(n,function(t,a){if(t&&angular.isString(t)){var e=c(t,!1,null,!0),i=e(o.$parent);angular.isDefined(i)?(n[a]=i,r++):o.$watch(function(){return e(o.$parent)},function(t){t&&(n[a]=t,r++)})}else r++})})},this.build=function(t,a){var e;if(t.target){if(t.target=l.ucfirst(t.target),t.manifest||t.id){o.Catalog[t.target]||(o.Catalog[t.target]={});var i=t.id||"manifest";t.decouple||!o.Catalog[t.target][i]?(e=new r({target:t.target,manifest:t.manifest,stagger:!0},{id:t.id}),t.decouple||(o.Catalog[t.target][i]=e)):o.Catalog[t.target][i]&&(e=o.Catalog[t.target][i])}else o.Catalog[t.target]||(o.Catalog[t.target]={}),t.decouple||!o.Catalog[t.target].collection?(e=new n({target:t.target}),t.decouple||(o.Catalog[t.target].collection=e)):o.Catalog[t.target].collection&&(e=o.Catalog[t.target].collection);t.api&&e.meta.set("api",l.isJSON(t.api)?JSON.parse(t.api):t.api),e.stagger&&"function"==typeof e.initialize&&e.initialize()}return angular.isObject(e)&&(void 0!==a&&((a.data=e)instanceof r?a.model=e:e instanceof n&&(a.collection=e)),e.pending||e.completed||e.fetch()),e}}}])}]});