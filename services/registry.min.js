!function(t,e){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","stratus.services.collection","stratus.services.model"],e):e(t.Stratus,t._,t.angular)}(this,function(l,g,s){l.Services.Registry=["$provide",function(t){t.factory("Registry",["Collection","Model","$interpolate","$q",function(u,f,c,t){return function(){this.fetch=function(a,o){var r=this;return new t(function(e,t){s.isString(a)&&(a={target:a});var i={target:a.attr?a.attr("data-target"):a.target,targetSuffix:a.attr?a.attr("data-target-suffix"):a.targetSuffix,id:a.attr?a.attr("data-id"):a.id,manifest:a.attr?a.attr("data-manifest"):a.manifest,decouple:a.attr?a.attr("data-decouple"):a.decouple,direct:a.attr?a.attr("data-direct"):a.direct,api:a.attr?a.attr("data-api"):a.api,urlRoot:a.attr?a.attr("data-url-root"):a.urlRoot},n=0;o.$watch(function(){return n},function(t){g.isNumber(t)&&parseInt(t)===g.size(i)&&e(r.build(i,o))}),g.each(i,function(t,e){if(t&&s.isString(t)){var a=c(t,!1,null,!0),r=a(o.$parent);s.isDefined(r)?(i[e]=r,n++):o.$watch(function(){return a(o.$parent)},function(t){t&&(i[e]=t,n++)})}else n++})})},this.build=function(t,e){var a;if(t.target){if(t.target=g.ucfirst(t.target),t.manifest||t.id){l.Catalog[t.target]||(l.Catalog[t.target]={});var r=t.id||"manifest";if(t.decouple||!l.Catalog[t.target][r]){var i={target:t.target,manifest:t.manifest,stagger:!0};t.urlRoot&&(i.urlRoot=t.urlRoot),t.targetSuffix&&(i.targetSuffix=t.targetSuffix),a=new f(i,{id:t.id}),t.decouple||(l.Catalog[t.target][r]=a)}else l.Catalog[t.target][r]&&(a=l.Catalog[t.target][r])}else{var n=t.direct?"Compendium":"Catalog";if(l[n][t.target]||(l[n][t.target]={}),t.decouple||!l[n][t.target].collection){var o={target:t.target,direct:!!t.direct};t.urlRoot&&(o.urlRoot=t.urlRoot),t.targetSuffix&&(o.targetSuffix=t.targetSuffix),a=new u(o),t.decouple||(l[n][t.target].collection=a)}else l[n][t.target].collection&&(a=l[n][t.target].collection)}t.api&&a.meta.set("api",g.isJSON(t.api)?JSON.parse(t.api):t.api),a.stagger&&"function"==typeof a.initialize&&a.initialize()}return s.isObject(a)&&(void 0!==e&&((e.data=a)instanceof f?e.model=a:a instanceof u&&(e.collection=a)),a.pending||a.completed||a.fetch()),a}}}])}]});