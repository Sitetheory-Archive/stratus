!function(t,e){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","stratus.services.collection","stratus.services.model"],e):e(t.Stratus,t._,t.angular)}(this,function(d,l,s){d.Services.Registry=["$provide",function(t){t.factory("Registry",["Collection","Model","$interpolate","$q",function(n,o,c,t){return function(){this.fetch=function(a,o){var i=this;return new t(function(e,t){s.isString(a)&&(a={target:a});var r={target:a.attr?a.attr("data-target"):a.target,id:a.attr?a.attr("data-id"):a.id,manifest:a.attr?a.attr("data-manifest"):a.manifest,decouple:a.attr?a.attr("data-decouple"):a.decouple,direct:a.attr?a.attr("data-direct"):a.direct,api:a.attr?a.attr("data-api"):a.api},n=0;o.$watch(function(){return n},function(t){l.isNumber(t)&&parseInt(t)===l.size(r)&&e(i.build(r,o))}),l.each(r,function(t,e){if(t&&s.isString(t)){var a=c(t,!1,null,!0),i=a(o.$parent);s.isDefined(i)?(r[e]=i,n++):o.$watch(function(){return a(o.$parent)},function(t){t&&(r[e]=t,n++)})}else n++})})},this.build=function(t,e){var a;if(t.target){if(t.target=l.ucfirst(t.target),t.manifest||t.id){d.Catalog[t.target]||(d.Catalog[t.target]={});var i=t.id||"manifest";t.decouple||!d.Catalog[t.target][i]?(a=new o({target:t.target,manifest:t.manifest,stagger:!0},{id:t.id}),t.decouple||(d.Catalog[t.target][i]=a)):d.Catalog[t.target][i]&&(a=d.Catalog[t.target][i])}else{var r=t.direct?"Compendium":"Catalog";d[r][t.target]||(d[r][t.target]={}),t.decouple||!d[r][t.target].collection?(a=new n({target:t.target,direct:!!t.direct}),t.decouple||(d[r][t.target].collection=a)):d[r][t.target].collection&&(a=d[r][t.target].collection)}t.api&&a.meta.set("api",l.isJSON(t.api)?JSON.parse(t.api):t.api),a.stagger&&"function"==typeof a.initialize&&a.initialize()}return s.isObject(a)&&(void 0!==e&&((e.data=a)instanceof o?e.model=a:a instanceof n&&(e.collection=a)),a.pending||a.completed||a.fetch()),a}}}])}]});