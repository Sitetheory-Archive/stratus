!function(t,a){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","stratus.services.collection","stratus.services.model"],a):a(t.Stratus,t._)}(this,function(t,a){t.Services.Registry=["$provide",function(e){e.factory("registry",["collection","model","$interpolate","$q",function(e,i,r,n){return function(){this.fetch=function(t,e){var i=this;return new n(function(n,o){angular.isString(t)&&(t={target:t});var c={target:t.attr?t.attr("data-target"):t.target,id:t.attr?t.attr("data-id"):t.id,manifest:t.attr?t.attr("data-manifest"):t.manifest,decouple:t.attr?t.attr("data-decouple"):t.decouple,api:t.attr?t.attr("data-api"):t.api},l=0;e.$watch(function(){return l},function(t){a.isNumber(t)&&parseInt(t)===a.size(c)&&n(i.build(c,e))}),a.each(c,function(t,a){if(t&&angular.isString(t)){var i=r(t,!1,null,!0),n=i(e.$parent);angular.isDefined(n)?(c[a]=n,l++):e.$watch(function(){return i(e.$parent)},function(t){t&&(c[a]=t,l++)})}else l++})})},this.build=function(r,n){var o;if(r.target){if(r.target=a.ucfirst(r.target),r.manifest||r.id){t.Catalog[r.target]||(t.Catalog[r.target]={});var c=r.id||"manifest";r.decouple||!t.Catalog[r.target][c]?(o=new i({target:r.target,manifest:r.manifest},{id:r.id}),r.decouple||(t.Catalog[r.target][c]=o)):t.Catalog[r.target][c]&&(o=t.Catalog[r.target][c])}else t.Catalog[r.target]||(t.Catalog[r.target]={}),r.decouple||!t.Catalog[r.target].collection?(o=new e({target:r.target}),r.decouple||(t.Catalog[r.target].collection=o)):t.Catalog[r.target].collection&&(o=t.Catalog[r.target].collection);r.api&&o.meta.set("api",a.isJSON(r.api)?JSON.parse(r.api):r.api)}return angular.isObject(o)&&("undefined"!=typeof n&&(n.data=o,o instanceof i?n.model=o:o instanceof e&&(n.collection=o)),o.pending||o.completed||o.fetch()),o}}}])}]});