!function(t,e){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","stratus.services.collection","stratus.services.model"],e):e(t.Stratus,t._,t.angular)}(this,function(t,e,a){t.Services.Registry=["$provide",function(r){r.factory("Registry",["Collection","Model","$interpolate",function(r,i,o){return function(){this.fetch=function(t,r){var i=this;return new Promise(function(n,u){a.isString(t)&&(t={target:t});var f={target:t.attr?t.attr("data-target"):t.target,targetSuffix:t.attr?t.attr("data-target-suffix"):t.targetSuffix,id:t.attr?t.attr("data-id"):t.id,manifest:t.attr?t.attr("data-manifest"):t.manifest,decouple:t.attr?t.attr("data-decouple"):t.decouple,direct:t.attr?t.attr("data-direct"):t.direct,api:t.attr?t.attr("data-api"):t.api,urlRoot:t.attr?t.attr("data-url-root"):t.urlRoot},c=0;r.$watch(function(){return c},function(t){e.isNumber(t)&&parseInt(t)===e.size(f)&&n(i.build(f,r))}),e.each(f,function(t,e){if(t&&a.isString(t)){var i=o(t,!1,null,!0),n=i(r.$parent);a.isDefined(n)?(f[e]=n,c++):r.$watch(function(){return i(r.$parent)},function(t){t&&(f[e]=t,c++)})}else c++})})},this.build=function(o,n){var u;if(o.target){if(o.target=e.ucfirst(o.target),o.manifest||o.id){t.Catalog[o.target]||(t.Catalog[o.target]={});var f=o.id||"manifest";if(o.decouple||!t.Catalog[o.target][f]){var c={target:o.target,manifest:o.manifest,stagger:!0};o.urlRoot&&(c.urlRoot=o.urlRoot),o.targetSuffix&&(c.targetSuffix=o.targetSuffix),u=new i(c,{id:o.id}),o.decouple||(t.Catalog[o.target][f]=u)}else t.Catalog[o.target][f]&&(u=t.Catalog[o.target][f])}else{var l=o.direct?"Compendium":"Catalog";if(t[l][o.target]||(t[l][o.target]={}),o.decouple||!t[l][o.target].collection){var g={target:o.target,direct:!!o.direct};o.urlRoot&&(g.urlRoot=o.urlRoot),o.targetSuffix&&(g.targetSuffix=o.targetSuffix),u=new r(g),o.decouple||(t[l][o.target].collection=u)}else t[l][o.target].collection&&(u=t[l][o.target].collection)}o.api&&u.meta.set("api",e.isJSON(o.api)?JSON.parse(o.api):o.api),u.stagger&&"function"==typeof u.initialize&&u.initialize()}return a.isObject(u)&&(void 0!==n&&(n.data=u,u instanceof i?n.model=u:u instanceof r&&(n.collection=u)),u.pending||u.completed||u.fetch()),u}}}])}]});