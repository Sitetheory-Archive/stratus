!function(t,a){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","stratus.services.collection","stratus.services.model"],a):a(t.Stratus,t._)}(this,function(l,g){l.Services.Registry=["$provide",function(t){t.factory("Registry",["Collection","Model","$interpolate","$q",function(n,o,c,t){return function(){this.fetch=function(e,o){var i=this;return new t(function(a,t){angular.isString(e)&&(e={target:e});var r={target:e.attr?e.attr("data-target"):e.target,id:e.attr?e.attr("data-id"):e.id,manifest:e.attr?e.attr("data-manifest"):e.manifest,decouple:e.attr?e.attr("data-decouple"):e.decouple,direct:e.attr?e.attr("data-direct"):e.direct,api:e.attr?e.attr("data-api"):e.api};l.Environment.get("production")||console.log("registry:",r,e);var n=0;o.$watch(function(){return n},function(t){g.isNumber(t)&&parseInt(t)===g.size(r)&&a(i.build(r,o))}),g.each(r,function(t,a){if(t&&angular.isString(t)){var e=c(t,!1,null,!0),i=e(o.$parent);angular.isDefined(i)?(r[a]=i,n++):o.$watch(function(){return e(o.$parent)},function(t){t&&(r[a]=t,n++)})}else n++})})},this.build=function(t,a){var e;if(t.target){if(t.target=g.ucfirst(t.target),t.manifest||t.id){l.Catalog[t.target]||(l.Catalog[t.target]={});var i=t.id||"manifest";t.decouple||!l.Catalog[t.target][i]?(e=new o({target:t.target,manifest:t.manifest,stagger:!0},{id:t.id}),t.decouple||(l.Catalog[t.target][i]=e)):l.Catalog[t.target][i]&&(e=l.Catalog[t.target][i])}else if(l.Catalog[t.target]||(l.Catalog[t.target]={}),t.decouple||!l.Catalog[t.target].collection){if(e=new n({target:t.target,direct:!!t.direct}),!t.decouple){var r=t.direct?"Compendium":"Catalog";l[r][t.target].collection=e}}else l.Catalog[t.target].collection&&(e=l.Catalog[t.target].collection);t.api&&e.meta.set("api",g.isJSON(t.api)?JSON.parse(t.api):t.api),e.stagger&&"function"==typeof e.initialize&&e.initialize()}return angular.isObject(e)&&(void 0!==a&&((a.data=e)instanceof o?a.model=e:e instanceof n&&(a.collection=e)),e.pending||e.completed||e.fetch()),e}}}])}]});