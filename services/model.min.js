!function(t,i){"function"==typeof define&&define.amd?define(["stratus","underscore","angular"],i):i(t.Stratus,t._)}(this,function(t,i){t.Services.Model=["$provide",function(e){e.factory("model",["$q","$http","$rootScope",function(e,a,n){return function(r,s){this.target=null,this.manifest=!1,this.stagger=!1,r&&"object"==typeof r||(r={}),angular.extend(this,r),this.urlRoot="/Api",this.data={},this.meta=new t.Prototypes.Model,i.has(this,"collection")&&(this.collection.target&&(this.target=this.collection.target),this.collection.meta.has("api")&&this.meta.set("api",this.collection.meta.get("api"))),s&&"object"==typeof s&&angular.extend(this.data,s),this.target&&(this.urlRoot+="/"+i.ucfirst(this.target)),this.pending=!1,this.error=!1,this.completed=!1,this.changing=!1,this.changed=0,this.saving=!1,this.watching=!1,this.patch={};var o=this;this.watcher=function(){return!!o.watching||(o.watching=!0,void n.$watch(function(){return o.data},function(e,a){var n=i.patch(e,a);n&&(e.id&&e.id!==a.id&&window.location.replace(t.Internals.SetUrlParams({id:e.id})),o.patch=i.extend(o.patch,n),o.changing=!0,o.changed=1)},!0))},this.url=function(){return o.get("id")?o.urlRoot+"/"+o.get("id"):o.urlRoot},this.serialize=function(t,i){var e=[];return t=t||{},angular.forEach(t,function(t,a){if(angular.isObject(t))e.push(o.serialize(t,a));else{var n="";i&&(n+=i+"["),n+=a,i&&(n+="]"),e.push(n+"="+t)}}),e.join("&")},this.sync=function(t,n){return this.pending=!0,e(function(e,r){t=t||"GET";var s={method:t,url:o.url(),headers:{}};angular.isDefined(n)&&("GET"===t?angular.isObject(n)&&Object.keys(n).length&&(s.url+="?"+o.serialize(n)):(s.headers["Content-Type"]="application/json",s.data=JSON.stringify(n))),a(s).then(function(t){if(200===t.status&&angular.isObject(t.data)){o.meta.set(t.data.meta||{});var a=t.data.payload||t.data;angular.isArray(a)&&a.length?(o.data=i.first(o.data),o.error=!1):angular.isObject(a)?(o.data=a,o.error=!1):o.error=!0,o.error||(o.pending=!1,o.completed=!0,o.saving=!1,o.patch={},o.watcher()),e(o.data)}else o.pending=!1,o.error=!0,r(t.statusText&&"OK"!==t.statusText?t.statusText:angular.isObject(t.data)?t.data:"Invalid Payload: "+s.method+" "+s.url)})["catch"](r)})},this.fetch=function(t,i){return o.sync(t,i||o.meta.get("api"))["catch"](function(t){console.error("FETCH:",t)})},this.save=function(){return o.changing=!1,o.saving=!0,o.sync(o.get("id")?"PUT":"POST",o.toJSON({patch:!0}))["catch"](function(t){console.error("SAVE:",t)})},this.toJSON=function(t){var i;return i=o.data,i=o.meta.has("api")?{meta:o.meta.get("api"),payload:i}:i,o.meta.size()>0&&o.meta.clearTemp(),i},o.toPatch=function(){return o.patch},this.get=function(t){return"string"==typeof t&&o.data&&"object"==typeof o.data?t.split(".").reduce(function(t,i){return t&&t[i]},o.data):void 0},this.set=function(t,e){t&&"object"==typeof t?i.each(t,function(t,i){o.setAttribute(i,t)},this):o.setAttribute(t,e)},this.setAttribute=function(t,e){if("string"==typeof t&&t.indexOf(".")!==-1){var a=o.data,n=t.split(".");if(i.find(i.initial(n),function(t){return i.has(a,t)&&a[t]||(a[t]={}),"undefined"!=typeof a&&a&&"object"==typeof a?void(a=a[t]):(a=o.data,!0)},this),!i.isEqual(a,o.data)){var r=i.last(n);a&&"object"==typeof a&&(a[r]=e)}}else o.data[t]=e},this.toggle=function(t,e,a){angular.isObject(a)&&angular.isDefined(a.multiple)&&angular.isUndefined(a.strict)&&(a.strict=!0),a=i.extend({multiple:!0},angular.isObject(a)?a:{});var n=t.split("[]."),r=o.get(n.length>1?n[0]:t);return(angular.isUndefined(r)||a.strict&&angular.isArray(r)!==a.multiple)&&(r=a.multiple?[]:null,o.set(n.length>1?n[0]:t,r)),angular.isUndefined(e)?o.set(t,!r):angular.isArray(r)?o.exists(t,e)?i.each(r,function(t,a){var s=n.length>1&&angular.isObject(t)&&n[1]in t?t[n[1]]:t,o=angular.isObject(s)&&s.id?s.id:s,c=angular.isObject(e)&&e.id?e.id:e;(o===c||angular.isString(o)&&angular.isString(c)&&0===i.strcmp(o,c))&&r.splice(a,1)}):r.push(e):"object"!=typeof r&&"number"!=typeof r||o.set(t,o.exists(t,e)?null:e),o.get(t)},this.pluck=function(t){if(!("string"==typeof t&&t.indexOf("[].")>-1))return o.get(t);var i=t.split("[].");if(i.length>1&&(t=o.get(i[0]),t&&angular.isArray(t))){var e=[];if(t.forEach(function(t){angular.isObject(t)&&i[1]in t&&e.push(t[i[1]])}),e.length)return e}},this.exists=function(t,e){return e?!("string"!=typeof t||!e)&&(t=o.pluck(t),angular.isArray(t)?"undefined"!=typeof t.find(function(t){return t===e||angular.isObject(t)&&t.id&&t.id===e||i.isEqual(t,e)}):t===e||angular.isObject(t)&&t.id&&(i.isEqual(t,e)||t.id===e)):(t=o.get(t),"undefined"!=typeof t&&t)},this.destroy=function(){o.collection&&o.collection.remove(o),o.get("id")&&o.sync("DELETE",{})["catch"](function(t){console.error("DESTROY:",t)})},this.initialize=i.once(this.initialize||function(){o.manifest&&!o.get("id")&&o.sync("POST",o.meta.has("api")?{meta:o.meta.get("api"),payload:{}}:{})["catch"](function(t){console.error("MANIFEST:",t)})}),o.stagger||this.initialize()}}])}]});