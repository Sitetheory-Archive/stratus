!function(t,e){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","angular-material","stratus.services.commonMethods"],e):e(t.Stratus,t._)}(this,function(t,e){t.Services.Model=["$provide",function(a){a.factory("model",["$q","$http","$mdToast","$rootScope","$log","commonMethods",function(a,i,n,r,s,o){return function(c,u){this.target=null,this.manifest=!1,this.stagger=!1,c&&"object"==typeof c||(c={}),angular.extend(this,c),this.urlRoot="/Api",this.data={},this.initData={},this.meta=new t.Prototypes.Model,e.has(this,"collection")&&(this.collection.target&&(this.target=this.collection.target),this.collection.meta.has("api")&&this.meta.set("api",this.collection.meta.get("api"))),u&&"object"==typeof u&&angular.extend(this.data,u),this.target&&(this.urlRoot+="/"+e.ucfirst(this.target)),this.pending=!1,this.error=!1,this.completed=!1,this.changed=!1,this.saving=!1,this.watching=!1,this.patch={};var l=this;this.watcher=function(){if(l.watching)return!0;l.watching=!0,r.$watch(function(){return l.data},function(a,i){var n=e.patch(a,i);s.log("patch:",n),e.isEmpty(l.initData)&&angular.copy(l.data,l.initData),n&&(l.changed=!angular.equals(a,l.initData),(a.id&&a.id!==i.id||l.isNewVersion(a))&&window.location.replace(t.Internals.SetUrlParams({id:a.id})),l.patch=e.extend(l.patch,n))},!0)},this.url=function(){var t=l.get("id")?l.urlRoot+"/"+l.get("id"):l.urlRoot;return t+="?",o.moreParams()&&angular.forEach(o.moreParams(),function(e,a){t+="options["+a+"]="+e}),t},this.serialize=function(t,e){var a=[];return t=t||{},angular.forEach(t,function(t,i){if(angular.isObject(t))a.push(l.serialize(t,i));else{var n="";e&&(n+=e+"["),n+=i,e&&(n+="]"),a.push(n+"="+t)}}),a.join("&")},this.sync=function(t,n){return this.pending=!0,a(function(a,r){var s={method:t=t||"GET",url:l.url(),headers:{}};angular.isDefined(n)&&("GET"===t?angular.isObject(n)&&Object.keys(n).length&&(s.url+="&"+l.serialize(n)):(s.headers["Content-Type"]="application/json",s.data=JSON.stringify(n))),i(s).then(function(t){if(200===t.status&&angular.isObject(t.data)){l.meta.set(t.data.meta||{});var i=t.data.payload||t.data;angular.isArray(i)&&i.length?(l.data=e.first(l.data),l.error=!1):angular.isObject(i)?(l.data=i,l.error=!1):l.error=!0,l.error||(l.pending=!1,l.completed=!0,l.saving=!1,l.patch={},l.watcher()),angular.copy(l.data,l.initData),a(l.data)}else l.pending=!1,l.error=!0,r(t.statusText&&"OK"!==t.statusText?t.statusText:angular.isObject(t.data)?t.data:"Invalid Payload: "+s.method+" "+s.url)}).catch(function(){r("XHR: "+s.method+" "+s.url)})})},this.fetch=function(t,e){return l.sync(t,e||l.meta.get("api")).catch(function(t){n.show(n.simple().textContent("Failure to Fetch!").toastClass("errorMessage").position("top right").hideDelay(3e3)),s.error("FETCH:",t)})},this.save=function(){return l.saving=!0,l.sync(l.get("id")?"PUT":"POST",l.toJSON({patch:!0})).catch(function(t){n.show(n.simple().textContent("Failure to Save!").toastClass("errorMessage").position("top right").hideDelay(3e3)),s.error("SAVE:",t)})},this.throttle=e.throttle(this.save,2e3),this.throttleSave=function(){return a(function(t,e){var a=l.throttle();s.log("throttle request:",a),a.then(function(e){s.log("throttle received:",e),t(e)}).catch(e)})},this.toJSON=function(t){var e;return e=l.data,e=l.meta.has("api")?{meta:l.meta.get("api"),payload:e}:e,l.meta.size()>0&&l.meta.clearTemp(),e},l.toPatch=function(){return l.patch},this.bracket={match:/\[[\d+]]/,search:/\[([\d+])]/g,attr:/(^[^\[]+)/},this.buildPath=function(t){var a=[];if(!e.isString(t))return a;var i,n;return e.each(t.split("."),function(t){if(t.match(l.bracket.match))for(null!==(i=l.bracket.attr.exec(t))?(a.push(i[1]),i=null):i=!1,n=l.bracket.search.exec(t);null!==n;)!1!==i&&(i=parseInt(n[1]),isNaN(i)?i=!1:a.push(i)),n=l.bracket.search.exec(t);else a.push(t)}),a},this.get=function(t){return"string"==typeof t&&l.data&&"object"==typeof l.data?l.buildPath(t).reduce(function(t,e){return t&&t[e]},l.data):void 0},this.isNewVersion=function(t){return!e.isEmpty(o.moreParams())&&t.version&&parseInt(o.moreParams().version)!=t.version.id},this.set=function(t,a){t&&"object"==typeof t?e.each(t,function(t,e){l.setAttribute(e,t)},this):l.setAttribute(t,a)},this.setAttribute=function(t,a){if("string"==typeof t&&(e.contains(t,".")||e.contains(t,"["))){var i;l.buildPath(t).reduce(function(t,n,r,s){return i=r+1,e.has(t,n)||(t[n]=e.has(s,i)&&e.isNumber(s[i])?[]:{}),e.has(s,i)||(t[n]=a),t&&t[n]},l.data)}else l.data[t]=a},this.toggle=function(t,a,i){angular.isObject(i)&&angular.isDefined(i.multiple)&&angular.isUndefined(i.strict)&&(i.strict=!0),i=e.extend({multiple:!0},angular.isObject(i)?i:{});var n=t.split("[]."),r=l.get(n.length>1?n[0]:t);return(angular.isUndefined(r)||i.strict&&angular.isArray(r)!==i.multiple)&&(r=i.multiple?[]:null,l.set(n.length>1?n[0]:t,r)),angular.isUndefined(a)?l.set(t,!r):angular.isArray(r)?l.exists(t,a)?e.each(r,function(t,i){var s=n.length>1&&angular.isObject(t)&&n[1]in t?t[n[1]]:t,o=angular.isObject(s)&&s.id?s.id:s,c=angular.isObject(a)&&a.id?a.id:a;(o===c||angular.isString(o)&&angular.isString(c)&&0===e.strcmp(o,c))&&r.splice(i,1)}):r.push(a):"object"!=typeof r&&"number"!=typeof r||l.set(t,l.exists(t,a)?null:a),l.get(t)},this.pluck=function(t){if(!("string"==typeof t&&t.indexOf("[].")>-1))return l.get(t);var e=t.split("[].");if(e.length>1&&(t=l.get(e[0]))&&angular.isArray(t)){var a=[];if(t.forEach(function(t){angular.isObject(t)&&e[1]in t&&a.push(t[e[1]])}),a.length)return a}},this.exists=function(t,a){return a?!("string"!=typeof t||!a)&&(t=l.pluck(t),angular.isArray(t)?void 0!==t.find(function(t){return t===a||angular.isObject(t)&&t.id&&t.id===a||e.isEqual(t,a)}):t===a||angular.isObject(t)&&t.id&&(e.isEqual(t,a)||t.id===a)):void 0!==(t=l.get(t))&&t},this.destroy=function(){l.collection&&l.collection.remove(l),l.get("id")&&l.sync("DELETE",{}).catch(function(t){n.show(n.simple().textContent("Failure to Delete!").toastClass("errorMessage").position("top right").hideDelay(3e3)),s.error("DESTROY:",t)})},this.initialize=e.once(this.initialize||function(){l.manifest&&!l.get("id")&&l.sync("POST",l.meta.has("api")?{meta:l.meta.get("api"),payload:{}}:{}).catch(function(t){n.show(n.simple().textContent("Failure to Manifest!").toastClass("errorMessage").position("top right").hideDelay(3e3)),s.error("MANIFEST:",t)})}),l.stagger||this.initialize()}}])}]});