!function(t,e){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","angular-material","stratus.services.commonMethods"],e):e(t.Stratus,t._,t.angular)}(this,function(h,u,l){h.Services.Model=["$provide",function(t){t.factory("Model",["$q","$http","$mdToast","$rootScope","$log","commonMethods",function(i,s,n,a,r,o){return function(t,e){this.target=null,this.manifest=!1,this.stagger=!1,this.urlRoot="/Api",t&&"object"==typeof t||(t={}),l.extend(this,t),this.identifier=null,this.data={},this.initData={},this.header=new h.Prototypes.Model,this.meta=new h.Prototypes.Model,u.has(this,"collection")&&(this.collection.target&&(this.target=this.collection.target),this.collection.meta.has("api")&&this.meta.set("api",this.collection.meta.get("api"))),e&&"object"==typeof e&&l.extend(this.data,e),this.target&&(this.urlRoot+="/"+u.ucfirst(this.target)),this.pending=!1,this.error=!1,this.completed=!1,this.changed=!1,this.saving=!1,this.watching=!1,this.patch={};var c=this;this.watcher=function(){if(c.watching)return!0;c.watching=!0,a.$watch(function(){return c.data},function(t,e){var i=u.patch(t,e);r.log("patch:",i),u.isEmpty(c.initData)&&l.copy(c.data,c.initData),i&&(c.changed=!l.equals(t,c.initData),(t.id&&t.id!==e.id||c.isNewVersion(t))&&window.location.replace(h.Internals.SetUrlParams({id:t.id})),c.patch=u.extend(c.patch,i))},!0)},this.getIdentifier=function(){return this.identifier=c.get("id")||c.identifier},this.getType=function(){return this.type=c.type||c.target||"orphan"},this.getHash=function(){return this.getType()+(u.isNumber(this.getIdentifier())?this.getIdentifier().toString():this.getIdentifier())},this.url=function(){var t=c.getIdentifier()?c.urlRoot+"/"+c.getIdentifier():c.urlRoot+(c.targetSuffix||"");return t+="?",u.getUrlParams("version")&&(t+="options[version]="+u.getUrlParams("version")),t},this.serialize=function(t,n){var a=[];return t=t||{},l.forEach(t,function(t,e){if(l.isObject(t))n&&(e=n+"["+e+"]"),a.push(c.serialize(t,e));else{var i="";n&&(i+=n+"["),i+=e,n&&(i+="]"),a.push(i+"="+t)}}),a.join("&")},this.sync=function(t,e){return this.pending=!0,i(function(i,n){var a={method:t=t||"GET",url:c.url(),headers:{}};l.isDefined(e)&&("GET"===t?l.isObject(e)&&Object.keys(e).length&&(a.url+="&"+c.serialize(e)):(a.headers["Content-Type"]="application/json",a.data=JSON.stringify(e))),s(a).then(function(t){if(200===t.status&&l.isObject(t.data)){c.header.set(t.headers()||{}),c.meta.set(t.data.meta||{});var e=t.data.payload||t.data;l.isArray(e)&&e.length?(c.data=u.first(e),c.error=!1):l.isObject(e)?(c.data=e,c.error=!1):c.error=!0,c.error||(c.pending=!1,c.completed=!0,c.saving=!1,c.patch={},c.watcher()),l.copy(c.data,c.initData),i(c.data)}else c.pending=!1,c.error=!0,n(t.statusText&&"OK"!==t.statusText?t.statusText:l.isObject(t.data)?t.data:"Invalid Payload: "+a.method+" "+a.url)}).catch(function(){n("XHR: "+a.method+" "+a.url)})})},this.fetch=function(t,e){return c.sync(t,e||c.meta.get("api")).catch(function(t){n.show(n.simple().textContent("Failure to Fetch!").toastClass("errorMessage").position("top right").hideDelay(3e3)),r.error("FETCH:",t)})},this.save=function(){return c.saving=!0,c.sync(c.getIdentifier()?"PUT":"POST",c.toJSON({patch:!0})).catch(function(t){n.show(n.simple().textContent("Failure to Save!").toastClass("errorMessage").position("top right").hideDelay(3e3)),r.error("SAVE:",t)})},this.specialAction=function(t){this.meta.temp("api.options.apiSpecialAction",t),this.save(),this.meta.get("api")&&this.meta.get("api").hasOwnProperty("options")&&this.meta.get("api").options.hasOwnProperty("apiSpecialAction")&&delete this.meta.get("api").options.apiSpecialAction},this.throttle=u.throttle(this.save,2e3),this.throttleSave=function(){return i(function(e,t){var i=c.throttle();r.log("throttle request:",i),i.then(function(t){r.log("throttle received:",t),e(t)}).catch(t)})},this.toJSON=function(t){var e;return e=c.data,e=c.meta.has("api")?{meta:c.meta.get("api"),payload:e}:e,0<c.meta.size()&&c.meta.clearTemp(),e},c.toPatch=function(){return c.patch},this.bracket={match:/\[[\d+]]/,search:/\[([\d+])]/g,attr:/(^[^[]+)/},this.buildPath=function(t){var e,i,n=[];return u.isString(t)&&u.each(t.split("."),function(t){if(t.match(c.bracket.match))for(null!==(e=c.bracket.attr.exec(t))?(n.push(e[1]),e=null):e=!1,i=c.bracket.search.exec(t);null!==i;)!1!==e&&(e=parseInt(i[1]),isNaN(e)?e=!1:n.push(e)),i=c.bracket.search.exec(t);else n.push(t)}),n},this.get=function(t){return"string"==typeof t&&c.data&&"object"==typeof c.data?c.buildPath(t).reduce(function(t,e){return t&&t[e]},c.data):void 0},this.find=function(t,e,i){return"string"==typeof t&&(t=c.get(t)),t instanceof Array?t.find(function(t){return t[e]===i}):t},this.isNewVersion=function(t){return!u.isEmpty(o.moreParams())&&t.version&&parseInt(o.moreParams().version)!==t.version.id},this.set=function(t,e){t&&"object"==typeof t?u.each(t,function(t,e){c.setAttribute(e,t)},this):c.setAttribute(t,e)},this.setAttribute=function(t,a){var s;"string"==typeof t&&(u.contains(t,".")||u.contains(t,"["))?c.buildPath(t).reduce(function(t,e,i,n){return s=i+1,u.has(t,e)||(t[e]=u.has(n,s)&&u.isNumber(n[s])?[]:{}),u.has(n,s)||(t[e]=a),t&&t[e]},c.data):c.data[t]=a},this.toggle=function(t,s,e){l.isObject(e)&&l.isDefined(e.multiple)&&l.isUndefined(e.strict)&&(e.strict=!0),e=u.extend({multiple:!0},l.isObject(e)?e:{});var r=t.split("[]."),o=c.get(1<r.length?r[0]:t);return(l.isUndefined(o)||e.strict&&l.isArray(o)!==e.multiple)&&(o=e.multiple?[]:null,c.set(1<r.length?r[0]:t,o)),l.isArray(o)?l.isUndefined(s)?c.set(t,null):c.exists(t,s)?u.each(o,function(t,e){var i=1<r.length&&l.isObject(t)&&r[1]in t?t[r[1]]:t,n=l.isObject(i)&&i.id?i.id:i,a=l.isObject(s)&&s.id?s.id:s;(n===a||l.isString(n)&&l.isString(a)&&0===u.strcmp(n,a))&&o.splice(e,1)}):o.push(s):"object"==typeof o||"number"==typeof o?c.set(t,c.exists(t,s)?null:s):l.isUndefined(s)&&c.set(t,!o),c.get(t)},this.pluck=function(t){if(!("string"==typeof t&&-1<t.indexOf("[].")))return c.get(t);var e=t.split("[].");if(1<e.length&&(t=c.get(e[0]))&&l.isArray(t)){var i=[];if(t.forEach(function(t){l.isObject(t)&&e[1]in t&&i.push(t[e[1]])}),i.length)return i}},this.exists=function(t,e){return e?!("string"!=typeof t||!e)&&(t=c.pluck(t),l.isArray(t)?void 0!==t.find(function(t){return t===e||l.isObject(t)&&t.id&&t.id===e||u.isEqual(t,e)}):t===e||l.isObject(t)&&t.id&&(u.isEqual(t,e)||t.id===e)):void 0!==(t=c.get(t))&&t},this.destroy=function(){c.collection&&c.collection.remove(c),c.getIdentifier()&&c.sync("DELETE",{}).catch(function(t){n.show(n.simple().textContent("Failure to Delete!").toastClass("errorMessage").position("top right").hideDelay(3e3)),r.error("DESTROY:",t)})},this.initialize=u.once(this.initialize||function(){c.manifest&&!c.getIdentifier()&&c.sync("POST",c.meta.has("api")?{meta:c.meta.get("api"),payload:{}}:{}).catch(function(t){n.show(n.simple().textContent("Failure to Manifest!").toastClass("errorMessage").position("top right").hideDelay(3e3)),r.error("MANIFEST:",t)})}),c.stagger||this.initialize()}}])}]});