!function(t,e){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","angular-material","stratus.services.commonMethods"],e):e(t.Stratus,t._)}(this,function(u,l){u.Services.Model=["$provide",function(t){t.factory("Model",["$q","$http","$mdToast","$rootScope","$log","commonMethods",function(i,r,a,n,s,o){return function(t,e){this.target=null,this.manifest=!1,this.stagger=!1,t&&"object"==typeof t||(t={}),angular.extend(this,t),this.identifier=null,this.urlRoot="/Api",this.data={},this.initData={},this.meta=new u.Prototypes.Model,l.has(this,"collection")&&(this.collection.target&&(this.target=this.collection.target),this.collection.meta.has("api")&&this.meta.set("api",this.collection.meta.get("api"))),e&&"object"==typeof e&&angular.extend(this.data,e),this.target&&(this.urlRoot+="/"+l.ucfirst(this.target)),this.pending=!1,this.error=!1,this.completed=!1,this.changed=!1,this.saving=!1,this.watching=!1,this.patch={};var c=this;this.watcher=function(){if(c.watching)return!0;c.watching=!0,n.$watch(function(){return c.data},function(t,e){var i=l.patch(t,e);s.log("patch:",i),l.isEmpty(c.initData)&&angular.copy(c.data,c.initData),i&&(c.changed=!angular.equals(t,c.initData),(t.id&&t.id!==e.id||c.isNewVersion(t))&&window.location.replace(u.Internals.SetUrlParams({id:t.id})),c.patch=l.extend(c.patch,i))},!0)},this.getIdentifier=function(){return this.identifier=c.get("id")||c.identifier},this.getType=function(){return this.type=c.type||c.target||"orphan"},this.getHash=function(){return this.getType()+(l.isNumber(this.getIdentifier())?this.getIdentifier().toString():this.getIdentifier())},this.url=function(){var t=c.getIdentifier()?c.urlRoot+"/"+c.getIdentifier():c.urlRoot;return t+="?",l.getUrlParams("version")&&(t+="options[version]="+l.getUrlParams("version")),t},this.serialize=function(t,a){var n=[];return t=t||{},angular.forEach(t,function(t,e){if(angular.isObject(t))n.push(c.serialize(t,e));else{var i="";a&&(i+=a+"["),i+=e,a&&(i+="]"),n.push(i+"="+t)}}),n.join("&")},this.sync=function(t,e){return this.pending=!0,i(function(i,a){var n={method:t=t||"GET",url:c.url(),headers:{}};angular.isDefined(e)&&("GET"===t?angular.isObject(e)&&Object.keys(e).length&&(n.url+="&"+c.serialize(e)):(n.headers["Content-Type"]="application/json",n.data=JSON.stringify(e))),r(n).then(function(t){if(200===t.status&&angular.isObject(t.data)){c.meta.set(t.data.meta||{});var e=t.data.payload||t.data;angular.isArray(e)&&e.length?(c.data=l.first(c.data),c.error=!1):angular.isObject(e)?(c.data=e,c.error=!1):c.error=!0,c.error||(c.pending=!1,c.completed=!0,c.saving=!1,c.patch={},c.watcher()),angular.copy(c.data,c.initData),i(c.data)}else c.pending=!1,c.error=!0,a(t.statusText&&"OK"!==t.statusText?t.statusText:angular.isObject(t.data)?t.data:"Invalid Payload: "+n.method+" "+n.url)}).catch(function(){a("XHR: "+n.method+" "+n.url)})})},this.fetch=function(t,e){return c.sync(t,e||c.meta.get("api")).catch(function(t){a.show(a.simple().textContent("Failure to Fetch!").toastClass("errorMessage").position("top right").hideDelay(3e3)),s.error("FETCH:",t)})},this.save=function(){return c.saving=!0,c.sync(c.getIdentifier()?"PUT":"POST",c.toJSON({patch:!0})).catch(function(t){a.show(a.simple().textContent("Failure to Save!").toastClass("errorMessage").position("top right").hideDelay(3e3)),s.error("SAVE:",t)})},this.throttle=l.throttle(this.save,2e3),this.throttleSave=function(){return i(function(e,t){var i=c.throttle();s.log("throttle request:",i),i.then(function(t){s.log("throttle received:",t),e(t)}).catch(t)})},this.toJSON=function(t){var e;return e=c.data,e=c.meta.has("api")?{meta:c.meta.get("api"),payload:e}:e,0<c.meta.size()&&c.meta.clearTemp(),e},c.toPatch=function(){return c.patch},this.bracket={match:/\[[\d+]]/,search:/\[([\d+])]/g,attr:/(^[^\[]+)/},this.buildPath=function(t){var e,i,a=[];return l.isString(t)&&l.each(t.split("."),function(t){if(t.match(c.bracket.match))for(null!==(e=c.bracket.attr.exec(t))?(a.push(e[1]),e=null):e=!1,i=c.bracket.search.exec(t);null!==i;)!1!==e&&(e=parseInt(i[1]),isNaN(e)?e=!1:a.push(e)),i=c.bracket.search.exec(t);else a.push(t)}),a},this.get=function(t){return"string"==typeof t&&c.data&&"object"==typeof c.data?c.buildPath(t).reduce(function(t,e){return t&&t[e]},c.data):void 0},this.isNewVersion=function(t){return!l.isEmpty(o.moreParams())&&t.version&&parseInt(o.moreParams().version)!=t.version.id},this.set=function(t,e){t&&"object"==typeof t?l.each(t,function(t,e){c.setAttribute(e,t)},this):c.setAttribute(t,e)},this.setAttribute=function(t,n){var r;"string"==typeof t&&(l.contains(t,".")||l.contains(t,"["))?c.buildPath(t).reduce(function(t,e,i,a){return r=i+1,l.has(t,e)||(t[e]=l.has(a,r)&&l.isNumber(a[r])?[]:{}),l.has(a,r)||(t[e]=n),t&&t[e]},c.data):c.data[t]=n},this.toggle=function(t,r,e){angular.isObject(e)&&angular.isDefined(e.multiple)&&angular.isUndefined(e.strict)&&(e.strict=!0),e=l.extend({multiple:!0},angular.isObject(e)?e:{});var s=t.split("[]."),o=c.get(1<s.length?s[0]:t);return(angular.isUndefined(o)||e.strict&&angular.isArray(o)!==e.multiple)&&(o=e.multiple?[]:null,c.set(1<s.length?s[0]:t,o)),angular.isUndefined(r)?c.set(t,!o):angular.isArray(o)?c.exists(t,r)?l.each(o,function(t,e){var i=1<s.length&&angular.isObject(t)&&s[1]in t?t[s[1]]:t,a=angular.isObject(i)&&i.id?i.id:i,n=angular.isObject(r)&&r.id?r.id:r;(a===n||angular.isString(a)&&angular.isString(n)&&0===l.strcmp(a,n))&&o.splice(e,1)}):o.push(r):"object"!=typeof o&&"number"!=typeof o||c.set(t,c.exists(t,r)?null:r),c.get(t)},this.pluck=function(t){if(!("string"==typeof t&&-1<t.indexOf("[].")))return c.get(t);var e=t.split("[].");if(1<e.length&&(t=c.get(e[0]))&&angular.isArray(t)){var i=[];if(t.forEach(function(t){angular.isObject(t)&&e[1]in t&&i.push(t[e[1]])}),i.length)return i}},this.exists=function(t,e){return e?!("string"!=typeof t||!e)&&(t=c.pluck(t),angular.isArray(t)?void 0!==t.find(function(t){return t===e||angular.isObject(t)&&t.id&&t.id===e||l.isEqual(t,e)}):t===e||angular.isObject(t)&&t.id&&(l.isEqual(t,e)||t.id===e)):void 0!==(t=c.get(t))&&t},this.destroy=function(){c.collection&&c.collection.remove(c),c.getIdentifier()&&c.sync("DELETE",{}).catch(function(t){a.show(a.simple().textContent("Failure to Delete!").toastClass("errorMessage").position("top right").hideDelay(3e3)),s.error("DESTROY:",t)})},this.initialize=l.once(this.initialize||function(){c.manifest&&!c.getIdentifier()&&c.sync("POST",c.meta.has("api")?{meta:c.meta.get("api"),payload:{}}:{}).catch(function(t){a.show(a.simple().textContent("Failure to Manifest!").toastClass("errorMessage").position("top right").hideDelay(3e3)),s.error("MANIFEST:",t)})}),c.stagger||this.initialize()}}])}]});