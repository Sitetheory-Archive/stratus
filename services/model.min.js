//     Stratus.Services.Model.js 1.0
//     Copyright (c) 2016 by Sitetheory, All Rights Reserved
//
//     All information contained herein is, and remains the
//     property of Sitetheory and its suppliers, if any.
//     The intellectual and technical concepts contained herein
//     are proprietary to Sitetheory and its suppliers and may be
//     covered by U.S. and Foreign Patents, patents in process,
//     and are protected by trade secret or copyright law.
//     Dissemination of this information or reproduction of this
//     material is strictly forbidden unless prior written
//     permission is obtained from Sitetheory.
//
//     For full details and documentation:
//     http://docs.sitetheory.io
!function(root,factory){"function"==typeof define&&define.amd?define(["stratus","underscore","angular"],factory):factory(root.Stratus,root._)}(this,function(Stratus,_){Stratus.Services.Model=["$provide",function($provide){$provide.factory("model",function($q,$http){return function(options,attributes){this.target=null,this.manifest=!1,options&&"object"==typeof options||(options={}),angular.extend(this,options),this.urlRoot="/Api",this.data={},this.meta=new Stratus.Prototypes.Collection,_.has(this,"collection")&&(this.collection.target&&(this.target=this.collection.target),this.collection.meta.has("api")&&this.meta.set("api",this.collection.meta.get("api"))),attributes&&"object"==typeof attributes&&angular.extend(this.data,attributes),this.target&&(this.urlRoot+="/"+_.ucfirst(this.target)),this.pending=!1,this.error=!1,this.completed=!1;var that=this;this.url=function(){return that.get("id")?that.urlRoot+"/"+that.get("id"):that.urlRoot},this.serialize=function(obj,chain){var str=[];return obj=obj||{},angular.forEach(obj,function(value,key){if(angular.isObject(value))str.push(that.serialize(value,key));else{var encoded="";chain&&(encoded+=chain+"["),encoded+=key,chain&&(encoded+="]"),str.push(encoded+"="+value)}}),str.join("&")},this.sync=function(action,data){return this.pending=!0,$q(function(resolve,reject){action=action||"GET";var prototype={method:action,url:that.url(),headers:{}};angular.isDefined(data)&&("GET"===action?angular.isObject(data)&&Object.keys(data).length&&(prototype.url+="?"+that.serialize(data)):(prototype.headers["Content-Type"]="application/json",prototype.data=JSON.stringify(data)));var request=$http(prototype);request.then(function(response){"200"==response.status?(that.meta.set(response.data.meta||{}),that.data=response.data.payload||response.data,that.pending=!1,that.completed=!0,resolve(that.data)):(that.pending=!1,that.error=!0,reject(response))},reject),request["catch"]&&request["catch"](reject)})},this.fetch=function(action,data){return that.sync(action,data||that.meta.get("api"))},this.save=function(){return that.sync(that.get("id")?"PUT":"POST",that.toJSON())},this.toJSON=function(){var data=that.meta.has("api")?{meta:that.meta.get("api"),payload:that.data}:that.data;return this.meta.size()>0&&this.meta.clearTemp(),data},this.get=function(attribute){return"string"==typeof attribute&&that.data&&"object"==typeof that.data?attribute.split(".").reduce(function(attributes,a){return attributes&&attributes[a]},that.data):void 0},this.set=function(attr,value){attr&&"object"==typeof attr?_.each(attr,function(value,attr){that.setAttribute(attr,value)},this):that.setAttribute(attr,value)},this.setAttribute=function(attr,value){if("string"==typeof attr&&attr.indexOf(".")!==-1){var reference=that.data,chain=attr.split(".");if(_.find(_.initial(chain),function(link){return _.has(reference,link)&&reference[link]||(reference[link]={}),"undefined"!=typeof reference&&reference&&"object"==typeof reference?void(reference=reference[link]):(reference=that.data,!0)},this),!_.isEqual(reference,that.data)){var link=_.last(chain);reference&&"object"==typeof reference&&(reference[link]=value)}}else that.data[attr]=value},this.toggle=function(attribute,item){var request=attribute.split("[]."),target=that.get(request.length>1?request[0]:attribute);if("undefined"==typeof item)that.set(attribute,!target);else if(angular.isArray(target)){var hydrate={};request.length>1?hydrate[request[1]]={id:item}:hydrate.id=item,that.exists(attribute,item)?_.each(target,function(element,key){var child=request.length>1&&angular.isObject(element)&&request[1]in element?element[request[1]]:element,childId=angular.isObject(child)&&child.id?child.id:child,itemId=angular.isObject(item)&&item.id?item.id:item;(childId===itemId||angular.isString(childId)&&angular.isString(itemId)&&0===_.strcmp(childId,itemId))&&target.splice(key,1)}):target.push(hydrate)}return that.get(attribute)},this.pluck=function(attribute){if(!("string"==typeof attribute&&attribute.indexOf("[].")>-1))return that.get(attribute);var request=attribute.split("[].");if(request.length>1&&(attribute=that.get(request[0]),attribute&&angular.isArray(attribute))){var list=[];if(attribute.forEach(function(element){angular.isObject(element)&&request[1]in element&&list.push(element[request[1]])}),list.length)return list}},this.exists=function(attribute,item){return item?!("string"!=typeof attribute||!item||(attribute=that.pluck(attribute),!angular.isArray(attribute)))&&"undefined"!=typeof attribute.find(function(element){return element===item||angular.isObject(element)&&element.id&&element.id===item}):(attribute=that.get(attribute),"undefined"!=typeof attribute&&attribute)},this.destroy=function(){that.collection&&that.collection.remove(that),that.get("id")&&that.sync("DELETE",{}).then(function(){},console.error)},this.initialize=this.initialize||function(){that.manifest&&!that.get("id")&&that.sync("POST",{}).then(function(){},console.error)},this.initialize()}})}]});