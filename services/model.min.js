!function(t,e){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","angular-material","stratus.services.commonMethods"],e):e(t.Stratus,t._)}(this,function(t,e){t.Services.Model=["$provide",function(i){i.factory("model",["$q","$http","$mdToast","$rootScope","$log","commonMethods",function(i,a,n,r,s,o){return function(c,u){this.target=null,this.manifest=!1,this.stagger=!1,c&&"object"==typeof c||(c={}),angular.extend(this,c),this.identifier=null,this.urlRoot="/Api",this.data={},this.initData={},this.meta=new t.Prototypes.Model,e.has(this,"collection")&&(this.collection.target&&(this.target=this.collection.target),this.collection.meta.has("api")&&this.meta.set("api",this.collection.meta.get("api"))),u&&"object"==typeof u&&angular.extend(this.data,u),this.target&&(this.urlRoot+="/"+e.ucfirst(this.target)),this.pending=!1,this.error=!1,this.completed=!1,this.changed=!1,this.saving=!1,this.watching=!1,this.patch={};var l=this;this.watcher=function(){if(l.watching)return!0;l.watching=!0,r.$watch(function(){return l.data},function(i,a){var n=e.patch(i,a);s.log("patch:",n),e.isEmpty(l.initData)&&angular.copy(l.data,l.initData),n&&(l.changed=!angular.equals(i,l.initData),(i.id&&i.id!==a.id||l.isNewVersion(i))&&window.location.replace(t.Internals.SetUrlParams({id:i.id})),l.patch=e.extend(l.patch,n))},!0)},this.getIdentifier=function(){return this.identifier=l.get("id")||l.identifier},this.url=function(){var t=l.getIdentifier()?l.urlRoot+"/"+l.getIdentifier():l.urlRoot;return t+="?",e.getUrlParams("version")&&(t+="options[version]="+e.getUrlParams("version")),t},this.serialize=function(t,e){var i=[];return t=t||{},angular.forEach(t,function(t,a){if(angular.isObject(t))i.push(l.serialize(t,a));else{var n="";e&&(n+=e+"["),n+=a,e&&(n+="]"),i.push(n+"="+t)}}),i.join("&")},this.sync=function(t,n){return this.pending=!0,i(function(i,r){var s={method:t=t||"GET",url:l.url(),headers:{}};angular.isDefined(n)&&("GET"===t?angular.isObject(n)&&Object.keys(n).length&&(s.url+="&"+l.serialize(n)):(s.headers["Content-Type"]="application/json",s.data=JSON.stringify(n))),a(s).then(function(t){if(200===t.status&&angular.isObject(t.data)){l.meta.set(t.data.meta||{});var a=t.data.payload||t.data;angular.isArray(a)&&a.length?(l.data=e.first(l.data),l.error=!1):angular.isObject(a)?(l.data=a,l.error=!1):l.error=!0,l.error||(l.pending=!1,l.completed=!0,l.saving=!1,l.patch={},l.watcher()),angular.copy(l.data,l.initData),i(l.data)}else l.pending=!1,l.error=!0,r(t.statusText&&"OK"!==t.statusText?t.statusText:angular.isObject(t.data)?t.data:"Invalid Payload: "+s.method+" "+s.url)}).catch(function(){r("XHR: "+s.method+" "+s.url)})})},this.fetch=function(t,e){return l.sync(t,e||l.meta.get("api")).catch(function(t){n.show(n.simple().textContent("Failure to Fetch!").toastClass("errorMessage").position("top right").hideDelay(3e3)),s.error("FETCH:",t)})},this.save=function(){return l.saving=!0,l.sync(l.getIdentifier()?"PUT":"POST",l.toJSON({patch:!0})).catch(function(t){n.show(n.simple().textContent("Failure to Save!").toastClass("errorMessage").position("top right").hideDelay(3e3)),s.error("SAVE:",t)})},this.throttle=e.throttle(this.save,2e3),this.throttleSave=function(){return i(function(t,e){var i=l.throttle();s.log("throttle request:",i),i.then(function(e){s.log("throttle received:",e),t(e)}).catch(e)})},this.toJSON=function(t){var e;return e=l.data,e=l.meta.has("api")?{meta:l.meta.get("api"),payload:e}:e,l.meta.size()>0&&l.meta.clearTemp(),e},l.toPatch=function(){return l.patch},this.bracket={match:/\[[\d+]]/,search:/\[([\d+])]/g,attr:/(^[^\[]+)/},this.buildPath=function(t){var i,a,n=[];return e.isString(t)?(e.each(t.split("."),function(t){if(t.match(l.bracket.match))for(null!==(i=l.bracket.attr.exec(t))?(n.push(i[1]),i=null):i=!1,a=l.bracket.search.exec(t);null!==a;)!1!==i&&(i=parseInt(a[1]),isNaN(i)?i=!1:n.push(i)),a=l.bracket.search.exec(t);else n.push(t)}),n):n},this.get=function(t){return"string"==typeof t&&l.data&&"object"==typeof l.data?l.buildPath(t).reduce(function(t,e){return t&&t[e]},l.data):void 0},this.isNewVersion=function(t){return!e.isEmpty(o.moreParams())&&t.version&&parseInt(o.moreParams().version)!=t.version.id},this.set=function(t,i){t&&"object"==typeof t?e.each(t,function(t,e){l.setAttribute(e,t)},this):l.setAttribute(t,i)},this.setAttribute=function(t,i){var a;"string"==typeof t&&(e.contains(t,".")||e.contains(t,"["))?l.buildPath(t).reduce(function(t,n,r,s){return a=r+1,e.has(t,n)||(t[n]=e.has(s,a)&&e.isNumber(s[a])?[]:{}),e.has(s,a)||(t[n]=i),t&&t[n]},l.data):l.data[t]=i},this.toggle=function(t,i,a){angular.isObject(a)&&angular.isDefined(a.multiple)&&angular.isUndefined(a.strict)&&(a.strict=!0),a=e.extend({multiple:!0},angular.isObject(a)?a:{});var n=t.split("[]."),r=l.get(n.length>1?n[0]:t);return(angular.isUndefined(r)||a.strict&&angular.isArray(r)!==a.multiple)&&(r=a.multiple?[]:null,l.set(n.length>1?n[0]:t,r)),angular.isUndefined(i)?l.set(t,!r):angular.isArray(r)?l.exists(t,i)?e.each(r,function(t,a){var s=n.length>1&&angular.isObject(t)&&n[1]in t?t[n[1]]:t,o=angular.isObject(s)&&s.id?s.id:s,c=angular.isObject(i)&&i.id?i.id:i;(o===c||angular.isString(o)&&angular.isString(c)&&0===e.strcmp(o,c))&&r.splice(a,1)}):r.push(i):"object"!=typeof r&&"number"!=typeof r||l.set(t,l.exists(t,i)?null:i),l.get(t)},this.pluck=function(t){if(!("string"==typeof t&&t.indexOf("[].")>-1))return l.get(t);var e=t.split("[].");if(e.length>1&&(t=l.get(e[0]))&&angular.isArray(t)){var i=[];if(t.forEach(function(t){angular.isObject(t)&&e[1]in t&&i.push(t[e[1]])}),i.length)return i}},this.exists=function(t,i){return i?!("string"!=typeof t||!i)&&(t=l.pluck(t),angular.isArray(t)?void 0!==t.find(function(t){return t===i||angular.isObject(t)&&t.id&&t.id===i||e.isEqual(t,i)}):t===i||angular.isObject(t)&&t.id&&(e.isEqual(t,i)||t.id===i)):void 0!==(t=l.get(t))&&t},this.destroy=function(){l.collection&&l.collection.remove(l),l.getIdentifier()&&l.sync("DELETE",{}).catch(function(t){n.show(n.simple().textContent("Failure to Delete!").toastClass("errorMessage").position("top right").hideDelay(3e3)),s.error("DESTROY:",t)})},this.initialize=e.once(this.initialize||function(){l.manifest&&!l.getIdentifier()&&l.sync("POST",l.meta.has("api")?{meta:l.meta.get("api"),payload:{}}:{}).catch(function(t){n.show(n.simple().textContent("Failure to Manifest!").toastClass("errorMessage").position("top right").hideDelay(3e3)),s.error("MANIFEST:",t)})}),l.stagger||this.initialize()}}])}]});