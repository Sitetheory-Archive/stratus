!function(root,factory){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","angular-material","stratus.services.utility"],factory):factory(root.Stratus,root._,root.angular)}(this,function(Stratus,_,angular){Stratus.Services.Model=["$provide",function($provide){$provide.factory("Model",["$q","$http","$mdToast","$rootScope","$log","utility",function($q,$http,$mdToast,$rootScope,$log,utility){return function(options,attributes){this.target=null,this.manifest=!1,this.stagger=!1,this.toast=!1,this.urlRoot="/Api",options&&"object"==typeof options||(options={}),angular.extend(this,options),this.identifier=null,this.data={},this.initData={},this.header=new Stratus.Prototypes.Model,this.meta=new Stratus.Prototypes.Model,_.has(this,"collection")&&(this.collection.target&&(this.target=this.collection.target),this.collection.meta.has("api")&&this.meta.set("api",this.collection.meta.get("api"))),attributes&&"object"==typeof attributes&&angular.extend(this.data,attributes),this.target&&(this.urlRoot+="/"+_.ucfirst(this.target)),this.pending=!1,this.error=!1,this.completed=!1,this.changed=!1,this.saving=!1,this.watching=!1,this.patch={};var that=this;this.watcher=function(){if(that.watching)return!0;that.watching=!0,$rootScope.$watch(function(){return that.data},function(newData,priorData){var patch=_.patch(newData,priorData);Stratus.Environment.get("production")||$log.log("Patch:",patch),_.isEmpty(that.initData)&&angular.copy(that.data,that.initData),patch&&(that.changed=!angular.equals(newData,that.initData),(newData.id&&newData.id!==priorData.id||that.isNewVersion(newData))&&window.location.replace(Stratus.Internals.SetUrlParams({id:newData.id})),that.patch=_.extend(that.patch,patch))},!0)},this.getIdentifier=function(){return this.identifier=that.get("id")||that.identifier},this.getType=function(){return this.type=that.type||that.target||"orphan"},this.getHash=function(){return this.getType()+(_.isNumber(this.getIdentifier())?this.getIdentifier().toString():this.getIdentifier())},this.url=function(){var url=that.getIdentifier()?that.urlRoot+"/"+that.getIdentifier():that.urlRoot+(that.targetSuffix||"");return _.getUrlParams("version")&&(url.includes("?")?url+="&":url+="?",url+="options[version]="+_.getUrlParams("version")),url},this.serialize=function(obj,chain){var str=[];return obj=obj||{},angular.forEach(obj,function(value,key){if(angular.isObject(value))chain&&(key=chain+"["+key+"]"),str.push(that.serialize(value,key));else{var encoded="";chain&&(encoded+=chain+"["),encoded+=key,chain&&(encoded+="]"),str.push(encoded+"="+value)}}),str.join("&")},this.sync=function(action,data,options){return this.pending=!0,$q(function(resolve,reject){action=action||"GET",options=options||{};var prototype={method:action,url:that.url(),headers:{}};angular.isDefined(data)&&("GET"===action?angular.isObject(data)&&Object.keys(data).length&&(prototype.url.includes("?")?prototype.url+="&":prototype.url+="?",prototype.url+=that.serialize(data)):(prototype.headers["Content-Type"]="application/json",prototype.data=JSON.stringify(data))),Stratus.Environment.get("production")||$log.log("Prototype:",prototype),options.hasOwnProperty("headers")&&"object"==typeof options.headers&&Object.keys(options.headers).forEach(function(headerKey){prototype.headers[headerKey]=options.headers[headerKey]}),$http(prototype).then(function(response){if(200===response.status&&angular.isObject(response.data)){that.header.set(response.headers()||{}),that.meta.set(response.data.meta||{});var convoy=response.data.payload||response.data;that.meta.has("status")&&"SUCCESS"!==_.first(that.meta.get("status")).code?that.error=!0:angular.isArray(convoy)&&convoy.length?(that.data=_.first(convoy),that.error=!1):angular.isObject(convoy)&&!angular.isArray(convoy)?(that.data=convoy,that.error=!1):that.error=!0,that.error||(that.completed=!0,that.saving=!1,that.patch={},that.watcher()),that.pending=!1,angular.copy(that.data,that.initData),resolve(that.data)}else that.pending=!1,that.error=!0,reject(response.statusText&&"OK"!==response.statusText?response.statusText:angular.isObject(response.data)?response.data:"Invalid Payload: "+prototype.method+" "+prototype.url)}).catch(function(){reject("XHR: "+prototype.method+" "+prototype.url)})})},this.fetch=function(action,data,options){return that.sync(action,data||that.meta.get("api"),options).catch(function(message){that.toast&&$mdToast.show($mdToast.simple().textContent("Failure to Fetch!").toastClass("errorMessage").position("top right").hideDelay(3e3)),$log.error("FETCH:",message)})},this.save=function(){return that.saving=!0,that.sync(that.getIdentifier()?"PUT":"POST",that.toJSON({patch:!0})).catch(function(message){that.toast&&$mdToast.show($mdToast.simple().textContent("Failure to Save!").toastClass("errorMessage").position("top right").hideDelay(3e3)),$log.error("SAVE:",message)})},this.specialAction=function(action){this.meta.temp("api.options.apiSpecialAction",action),this.save(),this.meta.get("api")&&this.meta.get("api").hasOwnProperty("options")&&this.meta.get("api").options.hasOwnProperty("apiSpecialAction")&&delete this.meta.get("api").options.apiSpecialAction},this.throttle=_.throttle(this.save,2e3),this.throttleSave=function(){return $q(function(resolve,reject){var request=that.throttle();$log.log("throttle request:",request),request.then(function(data){$log.log("throttle received:",data),resolve(data)}).catch(reject)})},this.toJSON=function(options){var data;return data=that.data,data=that.meta.has("api")?{meta:that.meta.get("api"),payload:data}:data,that.meta.size()>0&&that.meta.clearTemp(),data},that.toPatch=function(){return that.patch},this.bracket={match:/\[[\d+]]/,search:/\[([\d+])]/g,attr:/(^[^[]+)/},this.buildPath=function(path){var cur,search,acc=[];return _.isString(path)?(_.each(path.split("."),function(link){if(link.match(that.bracket.match))for(null!==(cur=that.bracket.attr.exec(link))?(acc.push(cur[1]),cur=null):cur=!1,search=that.bracket.search.exec(link);null!==search;)!1!==cur&&(cur=parseInt(search[1]),isNaN(cur)?cur=!1:acc.push(cur)),search=that.bracket.search.exec(link);else acc.push(link)}),acc):acc},this.get=function(attr){return"string"==typeof attr&&that.data&&"object"==typeof that.data?that.buildPath(attr).reduce(function(attrs,link){return attrs&&attrs[link]},that.data):void 0},this.find=function(attributes,key,value){return"string"==typeof attributes&&(attributes=that.get(attributes)),attributes instanceof Array?attributes.find(function(obj){return obj[key]===value}):attributes},this.isNewVersion=function(newData){return!_.isEmpty(utility.moreParams())&&newData.version&&parseInt(utility.moreParams().version)!==newData.version.id},this.set=function(attr,value){attr&&"object"==typeof attr?_.each(attr,function(value,attr){that.setAttribute(attr,value)},this):that.setAttribute(attr,value)},this.setAttribute=function(attr,value){var future;"string"==typeof attr&&(_.contains(attr,".")||_.contains(attr,"["))?that.buildPath(attr).reduce(function(attrs,link,index,chain){return future=index+1,_.has(attrs,link)||(attrs[link]=_.has(chain,future)&&_.isNumber(chain[future])?[]:{}),_.has(chain,future)||(attrs[link]=value),attrs&&attrs[link]},that.data):that.data[attr]=value},this.toggle=function(attribute,item,options){angular.isObject(options)&&angular.isDefined(options.multiple)&&angular.isUndefined(options.strict)&&(options.strict=!0),options=_.extend({multiple:!0},angular.isObject(options)?options:{});var request=attribute.split("[]."),target=that.get(request.length>1?request[0]:attribute);return(angular.isUndefined(target)||options.strict&&angular.isArray(target)!==options.multiple)&&(target=options.multiple?[]:null,that.set(request.length>1?request[0]:attribute,target)),angular.isArray(target)?angular.isUndefined(item)?that.set(attribute,null):that.exists(attribute,item)?_.each(target,function(element,key){var child=request.length>1&&angular.isObject(element)&&request[1]in element?element[request[1]]:element,childId=angular.isObject(child)&&child.id?child.id:child,itemId=angular.isObject(item)&&item.id?item.id:item;(childId===itemId||angular.isString(childId)&&angular.isString(itemId)&&0===_.strcmp(childId,itemId))&&target.splice(key,1)}):target.push(item):"object"==typeof target||"number"==typeof target?that.set(attribute,that.exists(attribute,item)?null:item):angular.isUndefined(item)&&that.set(attribute,!target),that.get(attribute)},this.pluck=function(attribute){if(!("string"==typeof attribute&&attribute.indexOf("[].")>-1))return that.get(attribute);var request=attribute.split("[].");if(request.length>1&&(attribute=that.get(request[0]))&&angular.isArray(attribute)){var list=[];if(attribute.forEach(function(element){angular.isObject(element)&&request[1]in element&&list.push(element[request[1]])}),list.length)return list}},this.exists=function(attribute,item){return item?!("string"!=typeof attribute||!item)&&(attribute=that.pluck(attribute),angular.isArray(attribute)?void 0!==attribute.find(function(element){return element===item||angular.isObject(element)&&element.id&&element.id===item||_.isEqual(element,item)}):attribute===item||angular.isObject(attribute)&&attribute.id&&(_.isEqual(attribute,item)||attribute.id===item)):void 0!==(attribute=that.get(attribute))&&attribute},this.destroy=function(){that.collection&&that.collection.remove(that),that.getIdentifier()&&that.sync("DELETE",{}).catch(function(message){that.toast&&$mdToast.show($mdToast.simple().textContent("Failure to Delete!").toastClass("errorMessage").position("top right").hideDelay(3e3)),$log.error("DESTROY:",message)})},this.initialize=_.once(this.initialize||function(){that.manifest&&!that.getIdentifier()&&that.sync("POST",that.meta.has("api")?{meta:that.meta.get("api"),payload:{}}:{}).catch(function(message){that.toast&&$mdToast.show($mdToast.simple().textContent("Failure to Manifest!").toastClass("errorMessage").position("top right").hideDelay(3e3)),$log.error("MANIFEST:",message)})}),that.stagger||this.initialize()}}])}]});