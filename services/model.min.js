!function(t,e){"function"==typeof define&&define.amd?define(["stratus","underscore","angular"],e):e(t.Stratus,t._)}(this,function(t,e){t.Services.Model=["$provide",function(i){i.factory("model",["$q","$http","$rootScope",function(i,n,a){return function(r,s){this.target=null,this.manifest=!1,this.stagger=!1,r&&"object"==typeof r||(r={}),angular.extend(this,r),this.urlRoot="/Api",this.data={},this.meta=new t.Prototypes.Model,e.has(this,"collection")&&(this.collection.target&&(this.target=this.collection.target),this.collection.meta.has("api")&&this.meta.set("api",this.collection.meta.get("api"))),s&&"object"==typeof s&&angular.extend(this.data,s),this.target&&(this.urlRoot+="/"+e.ucfirst(this.target)),this.pending=!1,this.error=!1,this.completed=!1,this.changing=!1,this.changed=0,this.saving=!1,this.watching=!1,this.patch={};var o=this;this.watcher=function(){return!!o.watching||(o.watching=!0,void a.$watch(function(){return o.data},function(i,n){var a=e.patch(i,n);a&&(i.id&&i.id!==n.id&&window.location.replace(t.Internals.SetUrlParams({id:i.id})),o.patch=e.extend(o.patch,a),console.log("patch:",o.patch),o.changing=!0,o.changed=1)},!0))},this.url=function(){return o.get("id")?o.urlRoot+"/"+o.get("id"):o.urlRoot},this.serialize=function(t,e){var i=[];return t=t||{},angular.forEach(t,function(t,n){if(angular.isObject(t))i.push(o.serialize(t,n));else{var a="";e&&(a+=e+"["),a+=n,e&&(a+="]"),i.push(a+"="+t)}}),i.join("&")},this.sync=function(t,a){return this.pending=!0,i(function(i,r){t=t||"GET";var s={method:t,url:o.url(),headers:{}};angular.isDefined(a)&&("GET"===t?angular.isObject(a)&&Object.keys(a).length&&(s.url+="?"+o.serialize(a)):(s.headers["Content-Type"]="application/json",s.data=JSON.stringify(a))),n(s).then(function(t){if(200===t.status&&angular.isObject(t.data)){o.meta.set(t.data.meta||{});var n=t.data.payload||t.data;angular.isArray(n)&&n.length?(o.data=e.first(o.data),o.error=!1):angular.isObject(n)?(o.data=n,o.error=!1):o.error=!0,o.error||(o.pending=!1,o.completed=!0,o.saving=!1,o.watcher()),i(o.data)}else o.pending=!1,o.error=!0,r(t.statusText&&"OK"!==t.statusText?t.statusText:angular.isObject(t.data)?t.data:"Invalid Payload: "+s.method+" "+s.url)})["catch"](r)})},this.fetch=function(t,e){return o.sync(t,e||o.meta.get("api"))["catch"](function(t){console.error("FETCH:",t)})},this.save=function(){return o.changing=!1,o.saving=!0,o.sync(o.get("id")?"PUT":"POST",o.toJSON({patch:!0}))["catch"](function(t){console.error("SAVE:",t)})},this.toJSON=function(t){var e;return e=o.data,e=o.meta.has("api")?{meta:o.meta.get("api"),payload:e}:e,o.meta.size()>0&&o.meta.clearTemp(),e},o.toPatch=function(){return o.patch},this.get=function(t){return"string"==typeof t&&o.data&&"object"==typeof o.data?t.split(".").reduce(function(t,e){return t&&t[e]},o.data):void 0},this.set=function(t,i){t&&"object"==typeof t?e.each(t,function(t,e){o.setAttribute(e,t)},this):o.setAttribute(t,i)},this.setAttribute=function(t,i){if("string"==typeof t&&t.indexOf(".")!==-1){var n=o.data,a=t.split(".");if(e.find(e.initial(a),function(t){return e.has(n,t)&&n[t]||(n[t]={}),"undefined"!=typeof n&&n&&"object"==typeof n?void(n=n[t]):(n=o.data,!0)},this),!e.isEqual(n,o.data)){var r=e.last(a);n&&"object"==typeof n&&(n[r]=i)}}else o.data[t]=i},this.toggle=function(t,i,n){"object"!=typeof n&&(n={multiple:!0}),console.log("toggle:",t,i,n);var a=t.split("[]."),r=o.get(a.length>1?a[0]:t);return"undefined"==typeof r&&(r=n.multiple?[]:null,o.set(a.length>1?a[0]:t,r)),"undefined"==typeof i?o.set(t,!r):angular.isArray(r)?o.exists(t,i)?e.each(r,function(t,n){var s=a.length>1&&angular.isObject(t)&&a[1]in t?t[a[1]]:t,o=angular.isObject(s)&&s.id?s.id:s,c=angular.isObject(i)&&i.id?i.id:i;(o===c||angular.isString(o)&&angular.isString(c)&&0===e.strcmp(o,c))&&r.splice(n,1)}):r.push(i):"object"!=typeof r&&"number"!=typeof r||o.set(t,o.exists(t,i)?null:i),o.get(t)},this.pluck=function(t){if(!("string"==typeof t&&t.indexOf("[].")>-1))return o.get(t);var e=t.split("[].");if(e.length>1&&(t=o.get(e[0]),t&&angular.isArray(t))){var i=[];if(t.forEach(function(t){angular.isObject(t)&&e[1]in t&&i.push(t[e[1]])}),i.length)return i}},this.exists=function(t,i){return i?!("string"!=typeof t||!i)&&(t=o.pluck(t),angular.isArray(t)?"undefined"!=typeof t.find(function(t){return t===i||angular.isObject(t)&&t.id&&t.id===i||e.isEqual(t,i)}):t===i||angular.isObject(t)&&t.id&&(e.isEqual(t,i)||t.id===i)):(t=o.get(t),"undefined"!=typeof t&&t)},this.destroy=function(){o.collection&&o.collection.remove(o),o.get("id")&&o.sync("DELETE",{})["catch"](function(t){console.error("DESTROY:",t)})},this.initialize=e.once(this.initialize||function(){o.manifest&&!o.get("id")&&o.sync("POST",o.meta.has("api")?{meta:o.meta.get("api"),payload:{}}:{})["catch"](function(t){console.error("MANIFEST:",t)})}),o.stagger||this.initialize()}}])}]});