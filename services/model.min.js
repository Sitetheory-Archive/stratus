//     Stratus.Services.Model.js 1.0
//     Copyright (c) 2016 by Sitetheory, All Rights Reserved
//
//     All information contained herein is, and remains the
//     property of Sitetheory and its suppliers, if any.
//     The intellectual and technical concepts contained herein
//     are proprietary to Sitetheory and its suppliers and may be
//     covered by U.S. and Foreign Patents, patents in process,
//     and are protected by trade secret or copyright law.
//     Dissemination of this information or reproduction of this
//     material is strictly forbidden unless prior written
//     permission is obtained from Sitetheory.
//
//     For full details and documentation:
//     http://docs.sitetheory.io
!function(root,factory){"function"==typeof define&&define.amd?define(["stratus","underscore","angular"],factory):factory(root.Stratus,root._)}(this,function(Stratus,_){Stratus.Services.Model=["$provide",function($provide){$provide.factory("model",function($q,$http){return function(options,attributes){this.target=null,this.manifest=!1,options&&"object"==typeof options||(options={}),angular.extend(this,options),this.urlRoot="/Api",this.data={},this.meta=new Stratus.Prototypes.Collection,_.has(this,"collection")&&(this.collection.target&&(this.target=this.collection.target),this.collection.meta.has("api")&&this.meta.set("api",this.collection.meta.get("api"))),attributes&&"object"==typeof attributes&&angular.extend(this.data,attributes),this.target&&(this.urlRoot+="/"+_.ucfirst(this.target)),this.pending=!1,this.error=!1,this.completed=!1;var that=this;this.url=function(){return that.get("id")?that.urlRoot+"/"+that.get("id"):that.urlRoot},this.serialize=function(obj,chain){var str=[];return obj=obj||{},angular.forEach(obj,function(value,key){if(angular.isObject(value))str.push(that.serialize(value,key));else{var encoded="";chain&&(encoded+=chain+"["),encoded+=key,chain&&(encoded+="]"),str.push(encoded+"="+value)}}),str.join("&")},this.sync=function(action,data){return this.pending=!0,$q(function(resolve,reject){action=action||"GET";var prototype={method:action,url:that.url(),headers:{action:action}};angular.isDefined(data)&&("GET"===action?angular.isObject(data)&&Object.keys(data).length&&(prototype.url+="?"+that.serialize(data)):(prototype.headers["Content-Type"]="application/json",prototype.data=JSON.stringify(data))),$http(prototype).then(function(response){"200"==response.status?(that.meta.set(response.data.meta||{}),that.data=response.data.payload||response.data,that.pending=!1,that.completed=!0,resolve(that.data)):(that.pending=!1,that.error=!0,reject(response))},reject)})},this.fetch=function(action,data){return that.sync(action,data||that.meta.get("api"))},this.save=function(){return that.sync(that.get("id")?"PUT":"POST",that.toJSON())},this.toJSON=function(){var data=that.meta.has("api")?{meta:that.meta.get("api"),payload:that.data}:that.data;return this.meta.size()>0&&this.meta.clearTemp(),data},this.get=function(attribute){return"string"==typeof attribute&&that.data&&"object"==typeof that.data?attribute.split(".").reduce(function(attributes,a){return attributes&&attributes[a]},that.data):void 0},this.toggle=function(attribute,item){return that.get(attribute)},this.pluck=function(attribute){if(!("string"==typeof attribute&&attribute.indexOf("[].")>-1))return that.get(attribute);var request=attribute.split("[].");if(request.length>1&&(attribute=that.get(request[0]),attribute&&angular.isArray(attribute))){var list=[];if(attribute.forEach(function(element){angular.isObject(element)&&request[1]in element&&list.push(element[request[1]])}),list.length)return list}},this.exists=function(attribute,item){return item?!("string"!=typeof attribute||!item||(attribute=that.pluck(attribute),!angular.isArray(attribute)))&&"undefined"!=typeof attribute.find(function(element){return element===item||angular.isObject(element)&&element.id&&element.id===item}):(attribute=that.get(attribute),"undefined"!=typeof attribute&&attribute)},this.initialize=this.initialize||function(){that.manifest&&!that.get("id")&&that.sync("POST",{}).then(function(){},console.error)},this.initialize()}})}]});