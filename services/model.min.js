!function(t,e){"function"==typeof define&&define.amd?define(["stratus","underscore","angular"],e):e(t.Stratus,t._)}(this,function(t,e){t.Services.Model=["$provide",function(i){i.factory("model",["$q","$http","$rootScope",function(i,n,a){return function(s,r){this.target=null,this.manifest=!1,s&&"object"==typeof s||(s={}),angular.extend(this,s),this.urlRoot="/Api",this.data={},this.meta=new t.Prototypes.Model,e.has(this,"collection")&&(this.collection.target&&(this.target=this.collection.target),this.collection.meta.has("api")&&this.meta.set("api",this.collection.meta.get("api"))),r&&"object"==typeof r&&angular.extend(this.data,r),this.target&&(this.urlRoot+="/"+e.ucfirst(this.target)),this.pending=!1,this.error=!1,this.completed=!1,this.changing=!1,this.changed=0,this.saving=!1,this.watching=!1;var o=this;this.watcher=function(){return!!o.watching||(o.watching=!0,void a.$watch(function(){return o.data},function(t,i){e.isEqual(t,i)||(o.changing=!0,o.changed=1)},!0))},this.url=function(){return o.get("id")?o.urlRoot+"/"+o.get("id"):o.urlRoot},this.serialize=function(t,e){var i=[];return t=t||{},angular.forEach(t,function(t,n){if(angular.isObject(t))i.push(o.serialize(t,n));else{var a="";e&&(a+=e+"["),a+=n,e&&(a+="]"),i.push(a+"="+t)}}),i.join("&")},this.sync=function(t,e){return this.pending=!0,i(function(i,a){t=t||"GET";var s={method:t,url:o.url(),headers:{}};angular.isDefined(e)&&("GET"===t?angular.isObject(e)&&Object.keys(e).length&&(s.url+="?"+o.serialize(e)):(s.headers["Content-Type"]="application/json",s.data=JSON.stringify(e))),n(s).then(function(t){200===t.status&&angular.isObject(t.data)?(o.meta.set(t.data.meta||{}),o.data=t.data.payload||t.data,o.pending=!1,o.completed=!0,o.saving=!1,o.watcher(),i(o.data)):(o.pending=!1,o.error=!0,a(t.statusText&&"OK"!==t.statusText?t.statusText:angular.isObject(t.data)?t.data:"Invalid Payload: "+s.method+" "+s.url))})["catch"](a)})},this.fetch=function(t,e){return o.sync(t,e||o.meta.get("api"))["catch"](console.error)},this.save=function(){return o.changing=!1,o.saving=!0,o.sync(o.get("id")?"PUT":"POST",o.toJSON())["catch"](console.error)},this.toJSON=function(){var t=o.meta.has("api")?{meta:o.meta.get("api"),payload:o.data}:o.data;return this.meta.size()>0&&this.meta.clearTemp(),t},this.get=function(t){return"string"==typeof t&&o.data&&"object"==typeof o.data?t.split(".").reduce(function(t,e){return t&&t[e]},o.data):void 0},this.set=function(t,i){t&&"object"==typeof t?e.each(t,function(t,e){o.setAttribute(e,t)},this):o.setAttribute(t,i)},this.setAttribute=function(t,i){if("string"==typeof t&&t.indexOf(".")!==-1){var n=o.data,a=t.split(".");if(e.find(e.initial(a),function(t){return e.has(n,t)&&n[t]||(n[t]={}),"undefined"!=typeof n&&n&&"object"==typeof n?void(n=n[t]):(n=o.data,!0)},this),!e.isEqual(n,o.data)){var s=e.last(a);n&&"object"==typeof n&&(n[s]=i)}}else o.data[t]=i},this.toggle=function(t,i,n){"object"!=typeof n&&(n={multiple:!0}),console.log("toggle:",t,i,n);var a=t.split("[]."),s=o.get(a.length>1?a[0]:t);return"undefined"==typeof s&&(s=n.multiple?[]:null,o.set(a.length>1?a[0]:t,s)),"undefined"==typeof i?o.set(t,!s):angular.isArray(s)?o.exists(t,i)?e.each(s,function(t,n){var r=a.length>1&&angular.isObject(t)&&a[1]in t?t[a[1]]:t,o=angular.isObject(r)&&r.id?r.id:r,c=angular.isObject(i)&&i.id?i.id:i;(o===c||angular.isString(o)&&angular.isString(c)&&0===e.strcmp(o,c))&&s.splice(n,1)}):s.push(i):"object"!=typeof s&&"number"!=typeof s||o.set(t,o.exists(t,i)?null:i),o.get(t)},this.pluck=function(t){if(!("string"==typeof t&&t.indexOf("[].")>-1))return o.get(t);var e=t.split("[].");if(e.length>1&&(t=o.get(e[0]),t&&angular.isArray(t))){var i=[];if(t.forEach(function(t){angular.isObject(t)&&e[1]in t&&i.push(t[e[1]])}),i.length)return i}},this.exists=function(t,i){return i?!("string"!=typeof t||!i)&&(t=o.pluck(t),angular.isArray(t)?"undefined"!=typeof t.find(function(t){return t===i||angular.isObject(t)&&t.id&&t.id===i||e.isEqual(t,i)}):t===i||angular.isObject(t)&&t.id&&(e.isEqual(t,i)||t.id===i)):(t=o.get(t),"undefined"!=typeof t&&t)},this.destroy=function(){o.collection&&o.collection.remove(o),o.get("id")&&o.sync("DELETE",{})["catch"](console.error)},this.initialize=this.initialize||function(){o.manifest&&!o.get("id")&&o.sync("POST",{})["catch"](console.error)},this.initialize()}}])}]});