!function(t,e){"function"==typeof define&&define.amd?define(["stratus","underscore","angular","angular-material"],e):e(t.Stratus,t._,t.angular)}(this,function(t,e,i){t.Services.Model=["$provide",function(s){s.factory("Model",["$http","$mdToast","$rootScope","$log",function(s,n,r,a){return class extends t.Prototypes.Model{constructor(s,r){super(r),this.name="AngularModel",this.target=null,this.manifest=!1,this.stagger=!1,this.toast=!1,this.urlRoot="/Api",s&&"object"==typeof s||(s={}),i.extend(this,s),this.identifier=null,this.data={},this.header=new t.Prototypes.Model,this.meta=new t.Prototypes.Model,e.has(this,"collection")&&(this.collection.target&&(this.target=this.collection.target),this.collection.meta.has("api")&&this.meta.set("api",this.collection.meta.get("api"))),r&&"object"==typeof r&&i.extend(this.data,r),this.target&&(this.urlRoot+="/"+e.ucfirst(this.target)),this.pending=!1,this.error=!1,this.completed=!1,this.changed=!1,this.saving=!1,this.watching=!1,this.patch={},this.bracket={match:/\[[\d+]]/,search:/\[([\d+])]/g,attr:/(^[^[]+)/},this.throttle=e.throttle(this.save,2e3),this.initialize=e.once(this.initialize||function(){const t=this;t.manifest&&!t.getIdentifier()&&t.sync("POST",t.meta.has("api")?{meta:t.meta.get("api"),payload:{}}:{}).catch(function(e){t.toast&&n.show(n.simple().textContent("Failure to Manifest!").toastClass("errorMessage").position("top right").hideDelay(3e3)),a.error("MANIFEST:",e)})}),this.stagger||this.initialize()}watcher(){if(this.watching)return!0;this.watching=!0;const i=this;r.$watch(function(){return i.data},function(s,n){const r=e.patch(s,n);if(t.Environment.get("production")||a.log("Patch:",r),!r)return!0;i.changed=!0;const o=e.getAnchorParams("version");(s.id&&s.id!==n.id||!e.isEmpty(o)&&s.version&&parseInt(o)!==s.version.id)&&window.location.replace(e.setUrlParams({id:s.id})),i.patch=e.extend(i.patch,r)},!0)}getIdentifier(){return this.identifier=this.get("id")||this.identifier}getType(){return this.type=this.type||this.target||"orphan"}getHash(){return this.getType()+(e.isNumber(this.getIdentifier())?this.getIdentifier().toString():this.getIdentifier())}url(){let t=this.getIdentifier()?this.urlRoot+"/"+this.getIdentifier():this.urlRoot+(this.targetSuffix||"");return e.getUrlParams("version")&&(t+=t.includes("?")?"&":"?",t+="options[version]="+e.getUrlParams("version")),t}serialize(t,e){const s=this,n=[];return t=t||{},i.forEach(t,function(t,r){if(i.isObject(t))e&&(r=e+"["+r+"]"),n.push(s.serialize(t,r));else{let i="";e&&(i+=e+"["),i+=r,e&&(i+="]"),n.push(i+"="+t)}}),n.join("&")}sync(n,r,o){this.pending=!0;const c=this;return new Promise(function(h,l){o=o||{};const u={method:n=n||"GET",url:c.url(),headers:{}};i.isDefined(r)&&("GET"===n?i.isObject(r)&&Object.keys(r).length&&(u.url+=u.url.includes("?")?"&":"?",u.url+=c.serialize(r)):(u.headers["Content-Type"]="application/json",u.data=JSON.stringify(r))),t.Environment.get("production")||a.log("Prototype:",u),o.hasOwnProperty("headers")&&"object"==typeof o.headers&&Object.keys(o.headers).forEach(function(t){u.headers[t]=o.headers[t]}),s(u).then(function(t){if(200===t.status&&i.isObject(t.data)){c.header.set(t.headers()||{}),c.meta.set(t.data.meta||{});const s=t.data.payload||t.data;c.meta.has("status")&&"SUCCESS"!==e.first(c.meta.get("status")).code?c.error=!0:i.isArray(s)&&s.length?(c.data=e.first(s),c.error=!1):i.isObject(s)&&!i.isArray(s)?(c.data=s,c.error=!1):c.error=!0,c.error||(c.completed=!0,c.saving=!1,c.patch={},c.watcher(),setTimeout(function(){c.changed=!1},100)),c.pending=!1,h(c.data)}else c.pending=!1,c.error=!0,l(t.statusText&&"OK"!==t.statusText?t.statusText:i.isObject(t.data)?t.data:"Invalid Payload: "+u.method+" "+u.url,t)}).catch(function(){console.error("XHR: "+u.method+" "+u.url),l.call(arguments)})})}fetch(t,e,i){const s=this;return s.sync(t,e||s.meta.get("api"),i).catch(function(t){s.toast&&n.show(n.simple().textContent("Failure to Fetch!").toastClass("errorMessage").position("top right").hideDelay(3e3)),a.error("FETCH:",t)})}save(){const t=this;return t.saving=!0,t.sync(t.getIdentifier()?"PUT":"POST",t.toJSON({patch:!0})).catch(function(e){t.toast&&n.show(n.simple().textContent("Failure to Save!").toastClass("errorMessage").position("top right").hideDelay(3e3)),a.error("SAVE:",e)})}specialAction(t){this.meta.temp("api.options.apiSpecialAction",t),this.save(),this.meta.get("api")&&this.meta.get("api").hasOwnProperty("options")&&this.meta.get("api").options.hasOwnProperty("apiSpecialAction")&&delete this.meta.get("api").options.apiSpecialAction}throttleSave(){const t=this;return new Promise(function(e,i){const s=t.throttle();a.log("throttle request:",s),s.then(function(t){a.log("throttle received:",t),e(t)}).catch(i)})}toJSON(t){const e=this;let i;return i=e.data,i=e.meta.has("api")?{meta:e.meta.get("api"),payload:i}:i,e.meta.size()>0&&e.meta.clearTemp(),i}toPatch(){return this.patch}buildPath(t){const i=[];if(!e.isString(t))return i;const s=this;let n,r;return e.each(t.split("."),function(t){if(t.match(s.bracket.match))for(null!==(n=s.bracket.attr.exec(t))?(i.push(n[1]),n=null):n=!1,r=s.bracket.search.exec(t);null!==r;)!1!==n&&(n=parseInt(r[1]),isNaN(n)?n=!1:i.push(n)),r=s.bracket.search.exec(t);else i.push(t)}),i}get(t){const e=this;return"string"==typeof t&&e.data&&"object"==typeof e.data?e.buildPath(t).reduce(function(t,e){return t&&t[e]},e.data):void 0}find(t,e,i){return"string"==typeof t&&(t=this.get(t)),t instanceof Array?t.find(function(t){return t[e]===i}):t}set(t,i){const s=this;t&&"object"==typeof t?e.each(t,function(t,e){s.setAttribute(e,t)},this):s.setAttribute(t,i)}setAttribute(t,i){const s=this;if("string"==typeof t&&(e.contains(t,".")||e.contains(t,"["))){let n;s.buildPath(t).reduce(function(t,s,r,a){return n=r+1,e.has(t,s)||(t[s]=e.has(a,n)&&e.isNumber(a[n])?[]:{}),e.has(a,n)||(t[s]=i),t&&t[s]},s.data)}else s.data[t]=i}toggle(t,s,n){const r=this;i.isObject(n)&&i.isDefined(n.multiple)&&i.isUndefined(n.strict)&&(n.strict=!0),n=e.extend({multiple:!0},i.isObject(n)?n:{});const a=t.split("[].");let o=r.get(a.length>1?a[0]:t);return(i.isUndefined(o)||n.strict&&i.isArray(o)!==n.multiple)&&(o=n.multiple?[]:null,r.set(a.length>1?a[0]:t,o)),i.isArray(o)?i.isUndefined(s)?r.set(t,null):r.exists(t,s)?e.each(o,function(t,n){const r=a.length>1&&i.isObject(t)&&a[1]in t?t[a[1]]:t,c=i.isObject(r)&&r.id?r.id:r,h=i.isObject(s)&&s.id?s.id:s;(c===h||i.isString(c)&&i.isString(h)&&0===e.strcmp(c,h))&&o.splice(n,1)}):o.push(s):"object"==typeof o||"number"==typeof o?r.set(t,r.exists(t,s)?null:s):i.isUndefined(s)&&r.set(t,!o),r.get(t)}pluck(t){const e=this;if("string"!=typeof t||-1===t.indexOf("[]."))return e.get(t);const s=t.split("[].");if(s.length<=1)return;if(!(t=e.get(s[0]))||!i.isArray(t))return;const n=[];return t.forEach(function(t){i.isObject(t)&&s[1]in t&&n.push(t[s[1]])}),n.length?n:void 0}exists(t,s){const n=this;return s?!("string"!=typeof t||!s)&&(t=n.pluck(t),i.isArray(t)?void 0!==t.find(function(t){return t===s||i.isObject(t)&&t.id&&t.id===s||e.isEqual(t,s)}):t===s||i.isObject(t)&&t.id&&(e.isEqual(t,s)||t.id===s)):void 0!==(t=n.get(t))&&t}destroy(){const t=this;t.collection&&t.collection.remove(t),t.getIdentifier()&&t.sync("DELETE",{}).catch(function(e){t.toast&&n.show(n.simple().textContent("Failure to Delete!").toastClass("errorMessage").position("top right").hideDelay(3e3)),a.error("DESTROY:",e)})}}}])}]});